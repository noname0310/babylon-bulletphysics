"use strict";(self.webpackChunkbabylon_bulletphysics=self.webpackChunkbabylon_bulletphysics||[]).push([[5246],{1675:(e,t,s)=>{s.d(t,{PD:()=>a,XG:()=>h,gs:()=>d,jm:()=>o});var r=s(1137);function i(e,t,s,r){switch(t){case 5120:{let t=e.getInt8(s);return r&&(t=Math.max(t/127,-1)),t}case 5121:{let t=e.getUint8(s);return r&&(t/=255),t}case 5122:{let t=e.getInt16(s,!0);return r&&(t=Math.max(t/32767,-1)),t}case 5123:{let t=e.getUint16(s,!0);return r&&(t/=65535),t}case 5124:return e.getInt32(s,!0);case 5125:return e.getUint32(s,!0);case 5126:return e.getFloat32(s,!0);default:throw new Error(`Invalid component type ${t}`)}}function n(e,t,s,r,i){switch(t){case 5120:r&&(i=Math.round(127*i)),e.setInt8(s,i);break;case 5121:r&&(i=Math.round(255*i)),e.setUint8(s,i);break;case 5122:r&&(i=Math.round(32767*i)),e.setInt16(s,i,!0);break;case 5123:r&&(i=Math.round(65535*i)),e.setUint16(s,i,!0);break;case 5124:e.setInt32(s,i,!0);break;case 5125:e.setUint32(s,i,!0);break;case 5126:e.setFloat32(s,i,!0);break;default:throw new Error(`Invalid component type ${t}`)}}function a(e){switch(e){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5124:case 5125:case 5126:return 4;default:throw new Error(`Invalid type '${e}'`)}}function h(e,t,s,r,h,o,d,c){const l=new Array(r),u=new Array(r);if(e instanceof Array){let i=t/4;const n=s/4;for(let t=0;t<o;t+=r){for(let t=0;t<r;t++)l[t]=u[t]=e[i+t];c(u,t);for(let t=0;t<r;t++)l[t]!==u[t]&&(e[i+t]=u[t]);i+=n}}else{const _=ArrayBuffer.isView(e)?new DataView(e.buffer,e.byteOffset,e.byteLength):new DataView(e),p=a(h);for(let e=0;e<o;e+=r){for(let e=0,s=t;e<r;e++,s+=p)l[e]=u[e]=i(_,h,s,d);c(u,e);for(let e=0,s=t;e<r;e++,s+=p)l[e]!==u[e]&&n(_,h,s,d,u[e]);t+=s}}}function o(e,t,s,i,n,o,d,c){const l=t*a(s),u=d*t;if(5126!==s||n!==l){const r=new Float32Array(u);return h(e,i,n,t,s,u,o,((e,s)=>{for(let i=0;i<t;i++)r[s+i]=e[i]})),r}if(!(e instanceof Array||e instanceof Float32Array)||0!==i||e.length!==u){if(e instanceof Array){const t=i/4;return e.slice(t,t+u)}if(e instanceof ArrayBuffer)return new Float32Array(e,i,u);{const t=e.byteOffset+i;return 3&t&&(r.V.Warn("Float array must be aligned to 4-bytes border"),c=!0),c?new Float32Array(e.buffer.slice(t,t+u*Float32Array.BYTES_PER_ELEMENT)):new Float32Array(e.buffer,t,u)}}return c?e.slice():e}function d(e,t,s,i,n,o,d,c){const l=t*a(s),u=d*t;if(c.length!==u)throw new Error("Output length is not valid");if(5126===s&&n===l)if(e instanceof Array){const t=i/4;c.set(e,t)}else if(e instanceof ArrayBuffer){const t=new Float32Array(e,i,u);c.set(t)}else{const t=e.byteOffset+i;if(3&t)return r.V.Warn("Float array must be aligned to 4-bytes border"),void c.set(new Float32Array(e.buffer.slice(t,t+u*Float32Array.BYTES_PER_ELEMENT)));const s=new Float32Array(e.buffer,t,u);c.set(s)}else h(e,i,n,t,s,u,o,((e,s)=>{for(let r=0;r<t;r++)c[s+r]=e[r]}))}},3099:(e,t,s)=>{s.d(t,{m:()=>h});var r=s(7931),i=s(9923);class n{set opaqueSortCompareFn(e){this._opaqueSortCompareFn=e||n.PainterSortCompare,this._renderOpaque=this._renderOpaqueSorted}set alphaTestSortCompareFn(e){this._alphaTestSortCompareFn=e||n.PainterSortCompare,this._renderAlphaTest=this._renderAlphaTestSorted}set transparentSortCompareFn(e){this._transparentSortCompareFn=e||n.defaultTransparentSortCompare,this._renderTransparent=this._renderTransparentSorted}constructor(e,t,s=null,i=null,n=null){this.index=e,this._opaqueSubMeshes=new r.L(256),this._transparentSubMeshes=new r.L(256),this._alphaTestSubMeshes=new r.L(256),this._depthOnlySubMeshes=new r.L(256),this._particleSystems=new r.L(256),this._spriteManagers=new r.L(256),this._empty=!0,this._edgesRenderers=new r.b(16),this._scene=t,this.opaqueSortCompareFn=s,this.alphaTestSortCompareFn=i,this.transparentSortCompareFn=n}render(e,t,s,r){if(e)return void e(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes,this._depthOnlySubMeshes);const i=this._scene.getEngine();0!==this._depthOnlySubMeshes.length&&(i.setColorWrite(!1),this._renderAlphaTest(this._depthOnlySubMeshes),i.setColorWrite(!0)),0!==this._opaqueSubMeshes.length&&this._renderOpaque(this._opaqueSubMeshes),0!==this._alphaTestSubMeshes.length&&this._renderAlphaTest(this._alphaTestSubMeshes);const n=i.getStencilBuffer();if(i.setStencilBuffer(!1),t&&this._renderSprites(),s&&this._renderParticles(r),this.onBeforeTransparentRendering&&this.onBeforeTransparentRendering(),0!==this._transparentSubMeshes.length||this._scene.useOrderIndependentTransparency){if(i.setStencilBuffer(n),this._scene.useOrderIndependentTransparency){const e=this._scene.depthPeelingRenderer.render(this._transparentSubMeshes);e.length&&this._renderTransparent(e)}else this._renderTransparent(this._transparentSubMeshes);i.setAlphaMode(0)}if(i.setStencilBuffer(!1),this._edgesRenderers.length){for(let e=0;e<this._edgesRenderers.length;e++)this._edgesRenderers.data[e].render();i.setAlphaMode(0)}i.setStencilBuffer(n)}_renderOpaqueSorted(e){n._RenderSorted(e,this._opaqueSortCompareFn,this._scene.activeCamera,!1)}_renderAlphaTestSorted(e){n._RenderSorted(e,this._alphaTestSortCompareFn,this._scene.activeCamera,!1)}_renderTransparentSorted(e){n._RenderSorted(e,this._transparentSortCompareFn,this._scene.activeCamera,!0)}static _RenderSorted(e,t,s,r){let a,h=0;const o=s?s.globalPosition:n._ZeroVector;if(r)for(;h<e.length;h++)a=e.data[h],a._alphaIndex=a.getMesh().alphaIndex,a._distanceToCamera=i.Pq.Distance(a.getBoundingInfo().boundingSphere.centerWorld,o);const d=e.length===e.data.length?e.data:e.data.slice(0,e.length);t&&d.sort(t);const c=d[0].getMesh().getScene();for(h=0;h<d.length;h++)if(a=d[h],!c._activeMeshesFrozenButKeepClipping||a.isInFrustum(c._frustumPlanes)){if(r){const e=a.getMaterial();if(e&&e.needDepthPrePass){const t=e.getScene().getEngine();t.setColorWrite(!1),t.setAlphaMode(0),a.render(!1),t.setColorWrite(!0)}}a.render(r)}}static defaultTransparentSortCompare(e,t){return e._alphaIndex>t._alphaIndex?1:e._alphaIndex<t._alphaIndex?-1:n.backToFrontSortCompare(e,t)}static backToFrontSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?1:e._distanceToCamera>t._distanceToCamera?-1:0}static frontToBackSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?-1:e._distanceToCamera>t._distanceToCamera?1:0}static PainterSortCompare(e,t){const s=e.getMesh(),r=t.getMesh();return s.material&&r.material?s.material.uniqueId-r.material.uniqueId:s.uniqueId-r.uniqueId}prepare(){this._opaqueSubMeshes.reset(),this._transparentSubMeshes.reset(),this._alphaTestSubMeshes.reset(),this._depthOnlySubMeshes.reset(),this._particleSystems.reset(),this.prepareSprites(),this._edgesRenderers.reset(),this._empty=!0}prepareSprites(){this._spriteManagers.reset()}dispose(){this._opaqueSubMeshes.dispose(),this._transparentSubMeshes.dispose(),this._alphaTestSubMeshes.dispose(),this._depthOnlySubMeshes.dispose(),this._particleSystems.dispose(),this._spriteManagers.dispose(),this._edgesRenderers.dispose()}dispatch(e,t,s){void 0===t&&(t=e.getMesh()),void 0===s&&(s=e.getMaterial()),null!=s&&(s.needAlphaBlendingForMesh(t)?this._transparentSubMeshes.push(e):s.needAlphaTestingForMesh(t)?(s.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._alphaTestSubMeshes.push(e)):(s.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._opaqueSubMeshes.push(e)),t._renderingGroup=this,t._edgesRenderer&&t.isEnabled()&&t.isVisible&&t._edgesRenderer.isEnabled&&this._edgesRenderers.pushNoDuplicate(t._edgesRenderer),this._empty=!1)}dispatchSprites(e){this._spriteManagers.push(e),this._empty=!1}dispatchParticles(e){this._particleSystems.push(e),this._empty=!1}_renderParticles(e){if(0===this._particleSystems.length)return;const t=this._scene.activeCamera;this._scene.onBeforeParticlesRenderingObservable.notifyObservers(this._scene);for(let s=0;s<this._particleSystems.length;s++){const r=this._particleSystems.data[s];if(0===(t&&t.layerMask&r.layerMask))continue;const i=r.emitter;i.position&&e&&-1===e.indexOf(i)||this._scene._activeParticles.addCount(r.render(),!1)}this._scene.onAfterParticlesRenderingObservable.notifyObservers(this._scene)}_renderSprites(){if(!this._scene.spritesEnabled||0===this._spriteManagers.length)return;const e=this._scene.activeCamera;this._scene.onBeforeSpritesRenderingObservable.notifyObservers(this._scene);for(let t=0;t<this._spriteManagers.length;t++){const s=this._spriteManagers.data[t];0!==(e&&e.layerMask&s.layerMask)&&s.render()}this._scene.onAfterSpritesRenderingObservable.notifyObservers(this._scene)}}n._ZeroVector=i.Pq.Zero();class a{}class h{get maintainStateBetweenFrames(){return this._maintainStateBetweenFrames}set maintainStateBetweenFrames(e){e!==this._maintainStateBetweenFrames&&(this._maintainStateBetweenFrames=e,this._maintainStateBetweenFrames||this.restoreDispachedFlags())}restoreDispachedFlags(){for(const e of this._scene.meshes)if(e.subMeshes)for(const t of e.subMeshes)t._wasDispatched=!1;if(this._scene.spriteManagers)for(const e of this._scene.spriteManagers)e._wasDispatched=!1;for(const e of this._scene.particleSystems)e._wasDispatched=!1}constructor(e){this._useSceneAutoClearSetup=!1,this._renderingGroups=new Array,this._autoClearDepthStencil={},this._customOpaqueSortCompareFn={},this._customAlphaTestSortCompareFn={},this._customTransparentSortCompareFn={},this._renderingGroupInfo=new a,this._maintainStateBetweenFrames=!1,this._scene=e;for(let e=h.MIN_RENDERINGGROUPS;e<h.MAX_RENDERINGGROUPS;e++)this._autoClearDepthStencil[e]={autoClear:!0,depth:!0,stencil:!0}}getRenderingGroup(e){const t=e||0;return this._prepareRenderingGroup(t),this._renderingGroups[t]}_clearDepthStencilBuffer(e=!0,t=!0){this._depthStencilBufferAlreadyCleaned||(this._scene.getEngine().clear(null,!1,e,t),this._depthStencilBufferAlreadyCleaned=!0)}render(e,t,s,r){const i=this._renderingGroupInfo;if(i.scene=this._scene,i.camera=this._scene.activeCamera,i.renderingManager=this,this._scene.spriteManagers&&r)for(let e=0;e<this._scene.spriteManagers.length;e++){const t=this._scene.spriteManagers[e];this.dispatchSprites(t)}for(let n=h.MIN_RENDERINGGROUPS;n<h.MAX_RENDERINGGROUPS;n++){this._depthStencilBufferAlreadyCleaned=n===h.MIN_RENDERINGGROUPS;const a=this._renderingGroups[n];if(!a||a._empty)continue;const o=1<<n;if(i.renderingGroupId=n,this._scene.onBeforeRenderingGroupObservable.notifyObservers(i,o),h.AUTOCLEAR){const e=this._useSceneAutoClearSetup?this._scene.getAutoClearDepthStencilSetup(n):this._autoClearDepthStencil[n];e&&e.autoClear&&this._clearDepthStencilBuffer(e.depth,e.stencil)}for(const e of this._scene._beforeRenderingGroupDrawStage)e.action(n);a.render(e,r,s,t);for(const e of this._scene._afterRenderingGroupDrawStage)e.action(n);this._scene.onAfterRenderingGroupObservable.notifyObservers(i,o)}}reset(){if(!this.maintainStateBetweenFrames)for(let e=h.MIN_RENDERINGGROUPS;e<h.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.prepare()}}resetSprites(){if(!this.maintainStateBetweenFrames)for(let e=h.MIN_RENDERINGGROUPS;e<h.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.prepareSprites()}}dispose(){this.freeRenderingGroups(),this._renderingGroups.length=0,this._renderingGroupInfo=null}freeRenderingGroups(){for(let e=h.MIN_RENDERINGGROUPS;e<h.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.dispose()}}_prepareRenderingGroup(e){void 0===this._renderingGroups[e]&&(this._renderingGroups[e]=new n(e,this._scene,this._customOpaqueSortCompareFn[e],this._customAlphaTestSortCompareFn[e],this._customTransparentSortCompareFn[e]))}dispatchSprites(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchSprites(e))}dispatchParticles(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchParticles(e))}dispatch(e,t,s){void 0===t&&(t=e.getMesh()),this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(t.renderingGroupId).dispatch(e,t,s))}setRenderingOrder(e,t=null,s=null,r=null){if(this._customOpaqueSortCompareFn[e]=t,this._customAlphaTestSortCompareFn[e]=s,this._customTransparentSortCompareFn[e]=r,this._renderingGroups[e]){const t=this._renderingGroups[e];t.opaqueSortCompareFn=this._customOpaqueSortCompareFn[e],t.alphaTestSortCompareFn=this._customAlphaTestSortCompareFn[e],t.transparentSortCompareFn=this._customTransparentSortCompareFn[e]}}setRenderingAutoClearDepthStencil(e,t,s=!0,r=!0){this._autoClearDepthStencil[e]={autoClear:t,depth:s,stencil:r}}getAutoClearDepthStencilSetup(e){return this._autoClearDepthStencil[e]}}h.MAX_RENDERINGGROUPS=4,h.MIN_RENDERINGGROUPS=0,h.AUTOCLEAR=!0},4255:(e,t,s)=>{s.d(t,{$:()=>c,J:()=>d});var r=s(5616),i=s(4494),n=s(9848),a=s(4420),h=s(5476);s(6612);const o={positions:[1,1,-1,1,-1,-1,1,-1],indices:[0,1,2,0,2,3]};class d{constructor(e,t=o){this._fullscreenViewport=new i.L(0,0,1,1);const s=t.positions??o.positions,n=t.indices??o.indices;this.engine=e,this._vertexBuffers={[r.R.PositionKind]:new r.R(e,s,r.R.PositionKind,!1,!1,2)},this._indexBuffer=e.createIndexBuffer(n),this._onContextRestoredObserver=e.onContextRestoredObservable.add((()=>{this._indexBuffer=e.createIndexBuffer(n);for(const e in this._vertexBuffers)this._vertexBuffers[e]._rebuild()}))}setViewport(e=this._fullscreenViewport){this.engine.setViewport(e)}bindBuffers(e){this.engine.bindBuffers(this._vertexBuffers,this._indexBuffer,e)}applyEffectWrapper(e){this.engine.setState(!0),this.engine.depthCullingState.depthTest=!1,this.engine.stencilState.stencilTest=!1,this.engine.enableEffect(e.drawWrapper),this.bindBuffers(e.effect),e.onApplyObservable.notifyObservers({})}saveStates(){this._savedStateDepthTest=this.engine.depthCullingState.depthTest,this._savedStateStencilTest=this.engine.stencilState.stencilTest}restoreStates(){this.engine.depthCullingState.depthTest=this._savedStateDepthTest,this.engine.stencilState.stencilTest=this._savedStateStencilTest}draw(){this.engine.drawElementsType(0,0,6)}_isRenderTargetTexture(e){return void 0!==e.renderTarget}render(e,t=null){if(!e.effect.isReady())return;this.saveStates(),this.setViewport();const s=null===t?null:this._isRenderTargetTexture(t)?t.renderTarget:t;s&&this.engine.bindFramebuffer(s),this.applyEffectWrapper(e),this.draw(),s&&this.engine.unBindFramebuffer(s),this.restoreStates()}dispose(){const e=this._vertexBuffers[r.R.PositionKind];e&&(e.dispose(),delete this._vertexBuffers[r.R.PositionKind]),this._indexBuffer&&this.engine._releaseBuffer(this._indexBuffer),this._onContextRestoredObserver&&(this.engine.onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}}class c{static RegisterShaderCodeProcessing(e,t){t?c._CustomShaderCodeProcessing[e??""]=t:delete c._CustomShaderCodeProcessing[e??""]}static _GetShaderCodeProcessing(e){return c._CustomShaderCodeProcessing[e]??c._CustomShaderCodeProcessing[""]}get name(){return this.options.name}set name(e){this.options.name=e}isReady(){return this._drawWrapper.effect?.isReady()??!1}get drawWrapper(){return this._drawWrapper}get effect(){return this._drawWrapper.effect}set effect(e){this._drawWrapper.effect=e}constructor(e){this.alphaMode=0,this.onEffectCreatedObservable=new n.cP(void 0,!0),this.onApplyObservable=new n.cP,this._shadersLoaded=!1,this._webGPUReady=!1,this._importPromises=[],this.options={...e,name:e.name||"effectWrapper",engine:e.engine,uniforms:e.uniforms||e.uniformNames||[],uniformNames:void 0,samplers:e.samplers||e.samplerNames||[],samplerNames:void 0,attributeNames:e.attributeNames||["position"],uniformBuffers:e.uniformBuffers||[],defines:e.defines||"",useShaderStore:e.useShaderStore||!1,vertexUrl:e.vertexUrl||e.vertexShader||"postprocess",vertexShader:void 0,fragmentShader:e.fragmentShader||"pass",indexParameters:e.indexParameters,blockCompilation:e.blockCompilation||!1,shaderLanguage:e.shaderLanguage||0,onCompiled:e.onCompiled||void 0,extraInitializations:e.extraInitializations||void 0,extraInitializationsAsync:e.extraInitializationsAsync||void 0,useAsPostProcess:e.useAsPostProcess??!1},this.options.uniformNames=this.options.uniforms,this.options.samplerNames=this.options.samplers,this.options.vertexShader=this.options.vertexUrl,this.options.useAsPostProcess&&(-1===this.options.samplers.indexOf("textureSampler")&&this.options.samplers.push("textureSampler"),-1===this.options.uniforms.indexOf("scale")&&this.options.uniforms.push("scale")),e.vertexUrl||e.vertexShader?this._shaderPath={vertexSource:this.options.vertexShader}:(this.options.useAsPostProcess||(this.options.uniforms.push("scale"),this.onApplyObservable.add((()=>{this.effect.setFloat2("scale",1,1)}))),this._shaderPath={vertex:this.options.vertexShader}),this._shaderPath.fragmentSource=this.options.fragmentShader,this._shaderPath.spectorName=this.options.name,this.options.useShaderStore&&(this._shaderPath.fragment=this._shaderPath.fragmentSource,this._shaderPath.vertex||(this._shaderPath.vertex=this._shaderPath.vertexSource),delete this._shaderPath.fragmentSource,delete this._shaderPath.vertexSource),this.onApplyObservable.add((()=>{this.bind()})),this.options.useShaderStore||(this._onContextRestoredObserver=this.options.engine.onContextRestoredObservable.add((()=>{this.effect._pipelineContext=null,this.effect._prepareEffect()}))),this._drawWrapper=new h.E(this.options.engine),this._webGPUReady=1===this.options.shaderLanguage;const t=Array.isArray(this.options.defines)?this.options.defines.join("\n"):this.options.defines;this._postConstructor(this.options.blockCompilation,t,this.options.extraInitializations)}_gatherImports(e=!1,t){this.options.useAsPostProcess&&(e&&this._webGPUReady?t.push(Promise.all([s.e(3126).then(s.bind(s,2083))])):t.push(Promise.all([Promise.resolve().then(s.bind(s,6612))])))}_postConstructor(e,t=null,s,r){this._importPromises.length=0,r&&this._importPromises.push(...r);const i=this.options.engine.isWebGPU&&!c.ForceGLSL;this._gatherImports(i,this._importPromises),void 0!==s&&s(i,this._importPromises),i&&this._webGPUReady&&(this.options.shaderLanguage=1),e||this.updateEffect(t)}updateEffect(e=null,t=null,s=null,r,i,n,h,o){const d=c._GetShaderCodeProcessing(this.name);if(d?.defineCustomBindings){const r=t?.slice()??[];r.push(...this.options.uniforms);const i=s?.slice()??[];i.push(...this.options.samplers),e=d.defineCustomBindings(this.name,e,r,i),t=r,s=i}this.options.defines=e||"";const l=this._shadersLoaded||0===this._importPromises.length?void 0:async()=>{await Promise.all(this._importPromises),this._shadersLoaded=!0};let u;u=this.options.extraInitializationsAsync?async()=>{l?.(),await this.options.extraInitializationsAsync}:l,this.options.useShaderStore?this._drawWrapper.effect=this.options.engine.createEffect({vertex:h??this._shaderPath.vertex,fragment:o??this._shaderPath.fragment},{attributes:this.options.attributeNames,uniformsNames:t||this.options.uniforms,uniformBuffersNames:this.options.uniformBuffers,samplers:s||this.options.samplers,defines:null!==e?e:"",fallbacks:null,onCompiled:i??this.options.onCompiled,onError:n??null,indexParameters:r||this.options.indexParameters,processCodeAfterIncludes:d?.processCodeAfterIncludes?(e,t)=>d.processCodeAfterIncludes(this.name,e,t):null,processFinalCode:d?.processFinalCode?(e,t)=>d.processFinalCode(this.name,e,t):null,shaderLanguage:this.options.shaderLanguage,extraInitializationsAsync:u},this.options.engine):this._drawWrapper.effect=new a.M(this._shaderPath,this.options.attributeNames,t||this.options.uniforms,s||this.options.samplerNames,this.options.engine,e,void 0,i||this.options.onCompiled,void 0,void 0,void 0,this.options.shaderLanguage,u),this.onEffectCreatedObservable.notifyObservers(this._drawWrapper.effect)}bind(){this.options.useAsPostProcess&&(this.options.engine.setAlphaMode(this.alphaMode),this.drawWrapper.effect.setFloat2("scale",1,1)),c._GetShaderCodeProcessing(this.name)?.bindCustomBindings?.(this.name,this._drawWrapper.effect)}dispose(e=!1){this._onContextRestoredObserver&&(this.effect.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null),this.onEffectCreatedObservable.clear(),this._drawWrapper.dispose(!0)}}c.ForceGLSL=!1,c._CustomShaderCodeProcessing={}},5476:(e,t,s)=>{s.d(t,{E:()=>i});var r=s(2940);class i{static GetEffect(e){return void 0===e.getPipelineContext?e.effect:e}constructor(e,t=!0){this._wasPreviouslyReady=!1,this._forceRebindOnNextCall=!0,this._wasPreviouslyUsingInstances=null,this.effect=null,this.defines=null,this.drawContext=e.createDrawContext(),t&&(this.materialContext=e.createMaterialContext())}setEffect(e,t,s=!0){this.effect=e,void 0!==t&&(this.defines=t),s&&this.drawContext?.reset()}dispose(e=!1){if(this.effect){const t=this.effect;e?t.dispose():r._.SetImmediate((()=>{t.getEngine().onEndFrameObservable.addOnce((()=>{t.dispose()}))})),this.effect=null}this.drawContext?.dispose()}}},5616:(e,t,s)=>{s.d(t,{R:()=>h,h:()=>a});var r=s(1504),i=s(1137),n=s(1675);class a{get isDisposed(){return this._isDisposed}constructor(e,t,s,i=0,n=!1,a=!1,h=!1,o,d){this._isAlreadyOwned=!1,this._isDisposed=!1,e&&e.getScene?this._engine=e.getScene().getEngine():this._engine=e,this._updatable=s,this._instanced=a,this._divisor=o||1,this._label=d,t instanceof r.n?(this._data=null,this._buffer=t):(this._data=t,this._buffer=null),this.byteStride=h?i:i*Float32Array.BYTES_PER_ELEMENT,n||this.create()}createVertexBuffer(e,t,s,r,i,n=!1,a){const o=n?t:t*Float32Array.BYTES_PER_ELEMENT,d=r?n?r:r*Float32Array.BYTES_PER_ELEMENT:this.byteStride;return new h(this._engine,this,e,this._updatable,!0,d,void 0===i?this._instanced:i,o,s,void 0,void 0,!0,this._divisor||a)}isUpdatable(){return this._updatable}getData(){return this._data}getBuffer(){return this._buffer}getStrideSize(){return this.byteStride/Float32Array.BYTES_PER_ELEMENT}create(e=null){!e&&this._buffer||(e=e||this._data)&&(this._buffer?this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e),this._data=e):this._updatable?(this._buffer=this._engine.createDynamicVertexBuffer(e,this._label),this._data=e):this._buffer=this._engine.createVertexBuffer(e,void 0,this._label))}_rebuild(){if(this._data)this._buffer=null,this.create(this._data);else{if(!this._buffer)return;if(this._buffer.capacity>0)return void(this._updatable?this._buffer=this._engine.createDynamicVertexBuffer(this._buffer.capacity,this._label):this._buffer=this._engine.createVertexBuffer(this._buffer.capacity,void 0,this._label));i.V.Warn(`Missing data for buffer "${this._label}" ${this._buffer?"(uniqueId: "+this._buffer.uniqueId+")":""}. Buffer reconstruction failed.`),this._buffer=null}}update(e){this.create(e)}updateDirectly(e,t,s,r=!1){this._buffer&&this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e,r?t:t*Float32Array.BYTES_PER_ELEMENT,s?s*this.byteStride:void 0),this._data=0===t&&void 0===s?e:null)}_increaseReferences(){this._buffer&&(this._isAlreadyOwned?this._buffer.references++:this._isAlreadyOwned=!0)}dispose(){this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._isDisposed=!0,this._data=null,this._buffer=null)}}class h{get isDisposed(){return this._isDisposed}get instanceDivisor(){return this._instanceDivisor}set instanceDivisor(e){const t=0!=e;this._instanceDivisor=e,t!==this._instanced&&(this._instanced=t,this._computeHashCode())}get _maxVerticesCount(){const e=this.getData();return e?Array.isArray(e)?e.length/(this.byteStride/4)-this.byteOffset/4:(e.byteLength-this.byteOffset)/this.byteStride:0}constructor(e,t,s,r,i,o,d,c,l,u,_=!1,p=!1,f=1,g=!1){this._isDisposed=!1;let b=!1;if(this.engine=e,"object"==typeof r&&null!==r?(b=r.updatable??!1,i=r.postponeInternalCreation,o=r.stride,d=r.instanced,c=r.offset,l=r.size,u=r.type,_=r.normalized??!1,p=r.useBytes??!1,f=r.divisor??1,g=r.takeBufferOwnership??!1,this._label=r.label):b=!!r,t instanceof a?(this._buffer=t,this._ownsBuffer=g):(this._buffer=new a(e,t,b,o,i,d,p,f,this._label),this._ownsBuffer=!0),this.uniqueId=h._Counter++,this._kind=s,void 0===u){const e=this.getData();this.type=e?h.GetDataType(e):h.FLOAT}else this.type=u;const m=(0,n.PD)(this.type);p?(this._size=l||(o?o/m:h.DeduceStride(s)),this.byteStride=o||this._buffer.byteStride||this._size*m,this.byteOffset=c||0):(this._size=l||o||h.DeduceStride(s),this.byteStride=o?o*m:this._buffer.byteStride||this._size*m,this.byteOffset=(c||0)*m),this.normalized=_,this._instanced=void 0!==d&&d,this._instanceDivisor=d?f:0,this._alignBuffer(),this._computeHashCode()}_computeHashCode(){this.hashCode=(this.type-5120|0)+((this.normalized?1:0)<<3)+(this._size<<4)+((this._instanced?1:0)<<6)+(this.byteStride<<12)}_rebuild(){this._buffer?._rebuild()}getKind(){return this._kind}isUpdatable(){return this._buffer.isUpdatable()}getData(){return this._buffer.getData()}getFloatData(e,t){const s=this.getData();return s?(0,n.jm)(s,this._size,this.type,this.byteOffset,this.byteStride,this.normalized,e,t):null}getBuffer(){return this._buffer.getBuffer()}getWrapperBuffer(){return this._buffer}getStrideSize(){return this.byteStride/(0,n.PD)(this.type)}getOffset(){return this.byteOffset/(0,n.PD)(this.type)}getSize(e=!1){return e?this._size*(0,n.PD)(this.type):this._size}getIsInstanced(){return this._instanced}getInstanceDivisor(){return this._instanceDivisor}create(e){this._buffer.create(e),this._alignBuffer()}update(e){this._buffer.update(e),this._alignBuffer()}updateDirectly(e,t,s=!1){this._buffer.updateDirectly(e,t,void 0,s),this._alignBuffer()}dispose(){this._ownsBuffer&&this._buffer.dispose(),this._isDisposed=!0}forEach(e,t){(0,n.XG)(this._buffer.getData(),this.byteOffset,this.byteStride,this._size,this.type,e,this.normalized,((e,s)=>{for(let r=0;r<this._size;r++)t(e[r],s+r)}))}_alignBuffer(){}static DeduceStride(e){switch(e){case h.UVKind:case h.UV2Kind:case h.UV3Kind:case h.UV4Kind:case h.UV5Kind:case h.UV6Kind:return 2;case h.NormalKind:case h.PositionKind:return 3;case h.ColorKind:case h.ColorInstanceKind:case h.MatricesIndicesKind:case h.MatricesIndicesExtraKind:case h.MatricesWeightsKind:case h.MatricesWeightsExtraKind:case h.TangentKind:return 4;default:throw new Error("Invalid kind '"+e+"'")}}static GetDataType(e){return e instanceof Int8Array?h.BYTE:e instanceof Uint8Array?h.UNSIGNED_BYTE:e instanceof Int16Array?h.SHORT:e instanceof Uint16Array?h.UNSIGNED_SHORT:e instanceof Int32Array?h.INT:e instanceof Uint32Array?h.UNSIGNED_INT:h.FLOAT}static GetTypeByteLength(e){return(0,n.PD)(e)}static ForEach(e,t,s,r,i,a,h,o){(0,n.XG)(e,t,s,r,i,a,h,((e,t)=>{for(let s=0;s<r;s++)o(e[s],t+s)}))}static GetFloatData(e,t,s,r,i,a,h,o){return(0,n.jm)(e,t,s,r,i,a,h,o)}}h._Counter=0,h.BYTE=5120,h.UNSIGNED_BYTE=5121,h.SHORT=5122,h.UNSIGNED_SHORT=5123,h.INT=5124,h.UNSIGNED_INT=5125,h.FLOAT=5126,h.PositionKind="position",h.NormalKind="normal",h.TangentKind="tangent",h.UVKind="uv",h.UV2Kind="uv2",h.UV3Kind="uv3",h.UV4Kind="uv4",h.UV5Kind="uv5",h.UV6Kind="uv6",h.ColorKind="color",h.ColorInstanceKind="instanceColor",h.MatricesIndicesKind="matricesIndices",h.MatricesWeightsKind="matricesWeights",h.MatricesIndicesExtraKind="matricesIndicesExtra",h.MatricesWeightsExtraKind="matricesWeightsExtra"},6096:(e,t,s)=>{s.d(t,{X:()=>n});var r=s(5616),i=s(9848);class n{constructor(e){this._vertexBuffers={},this.onBeforeRenderObservable=new i.cP,this._scene=e}_prepareBuffers(){if(this._vertexBuffers[r.R.PositionKind])return;const e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1),this._vertexBuffers[r.R.PositionKind]=new r.R(this._scene.getEngine(),e,r.R.PositionKind,!1,!1,2),this._buildIndexBuffer()}_buildIndexBuffer(){const e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(e)}_rebuild(){const e=this._vertexBuffers[r.R.PositionKind];e&&(e._rebuild(),this._buildIndexBuffer())}_prepareFrame(e=null,t=null){const s=this._scene.activeCamera;return!(!s||!(t=t||s._postProcesses.filter((e=>null!=e)))||0===t.length||!this._scene.postProcessesEnabled||(t[0].activate(s,e,null!=t),0))}directRender(e,t=null,s=!1,r=0,i=0,n=!1){const a=this._scene.getEngine();for(let h=0;h<e.length;h++){h<e.length-1?e[h+1].activate(this._scene.activeCamera||this._scene,t?.texture):(t?a.bindFramebuffer(t,r,void 0,void 0,s,i):n||a.restoreDefaultFramebuffer(),a._debugInsertMarker?.(`post process ${e[h].name} output`));const o=e[h],d=o.apply();d&&(o.onBeforeRenderObservable.notifyObservers(d),this._prepareBuffers(),a.bindBuffers(this._vertexBuffers,this._indexBuffer,d),a.drawElementsType(0,0,6),o.onAfterRenderObservable.notifyObservers(d))}a.setDepthBuffer(!0),a.setDepthWrite(!0)}_finalizeFrame(e,t,s,r,i=!1){const n=this._scene.activeCamera;if(!n)return;if(this.onBeforeRenderObservable.notifyObservers(this),0===(r=r||n._postProcesses.filter((e=>null!=e))).length||!this._scene.postProcessesEnabled)return;const a=this._scene.getEngine();for(let h=0,o=r.length;h<o;h++){const d=r[h];if(h<o-1?d._outputTexture=r[h+1].activate(n,t?.texture):(t?(a.bindFramebuffer(t,s,void 0,void 0,i),d._outputTexture=t):(a.restoreDefaultFramebuffer(),d._outputTexture=null),a._debugInsertMarker?.(`post process ${r[h].name} output`)),e)break;const c=d.apply();c&&(d.onBeforeRenderObservable.notifyObservers(c),this._prepareBuffers(),a.bindBuffers(this._vertexBuffers,this._indexBuffer,c),a.drawElementsType(0,0,6),d.onAfterRenderObservable.notifyObservers(c))}a.setDepthBuffer(!0),a.setDepthWrite(!0),a.setAlphaMode(0)}dispose(){const e=this._vertexBuffers[r.R.PositionKind];e&&(e.dispose(),this._vertexBuffers[r.R.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null)}}},6882:(e,t,s)=>{s.d(t,{$:()=>_});var r=s(9848),i=s(9923),n=s(2781),a=s(6096),h=s(1597),o=s(4420),d=s(1137),c=s(3099),l=s(7309);class u{get renderList(){return this._renderList}set renderList(e){this._renderList!==e&&(this._unObserveRenderList&&(this._unObserveRenderList(),this._unObserveRenderList=null),e&&(this._unObserveRenderList=(0,l.lL)(e,this._renderListHasChanged)),this._renderList=e)}get name(){return this._name}set name(e){if(this._name===e)return;if(this._name=e,!this._scene)return;const t=this._scene.getEngine();for(let e=0;e<this._renderPassIds.length;++e){const s=this._renderPassIds[e];t._renderPassNames[s]=`${this._name}#${e}`}}get renderPassIds(){return this._renderPassIds}get currentRefreshId(){return this._currentRefreshId}setMaterialForRendering(e,t){let s;s=Array.isArray(e)?e:[e];for(let e=0;e<s.length;++e)for(let r=0;r<this.options.numPasses;++r)s[e].setMaterialForRenderPass(this._renderPassIds[r],void 0!==t?Array.isArray(t)?t[r]:t:void 0)}constructor(e,t,s){this._unObserveRenderList=null,this._renderListHasChanged=(e,t)=>{const s=this._renderList?this._renderList.length:0;(0===t&&s>0||0===s)&&this._scene.meshes.forEach((e=>{e._markSubMeshesAsLightDirty()}))},this.particleSystemList=null,this.getCustomRenderList=null,this.renderParticles=!0,this.renderSprites=!1,this.forceLayerMaskCheck=!1,this.onBeforeRenderObservable=new r.cP,this.onAfterRenderObservable=new r.cP,this.onBeforeRenderingManagerRenderObservable=new r.cP,this.onAfterRenderingManagerRenderObservable=new r.cP,this.onFastPathRenderObservable=new r.cP,this._currentRefreshId=-1,this._refreshRate=1,this._currentSceneCamera=null,this.name=e,this._scene=t,this.renderList=[],this._renderPassIds=[],this.options={numPasses:1,doNotChangeAspectRatio:!0,...s},this._createRenderPassId(),this.renderPassId=this._renderPassIds[0],this._renderingManager=new c.m(t),this._renderingManager._useSceneAutoClearSetup=!0}_releaseRenderPassId(){const e=this._scene.getEngine();for(let t=0;t<this.options.numPasses;++t)e.releaseRenderPassId(this._renderPassIds[t]);this._renderPassIds.length=0}_createRenderPassId(){this._releaseRenderPassId();const e=this._scene.getEngine();for(let t=0;t<this.options.numPasses;++t)this._renderPassIds[t]=e.createRenderPassId(`${this.name}#${t}`)}resetRefreshCounter(){this._currentRefreshId=-1}get refreshRate(){return this._refreshRate}set refreshRate(e){this._refreshRate=e,this.resetRefreshCounter()}shouldRender(){return-1===this._currentRefreshId||this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)}isReadyForRendering(e,t){this.prepareRenderList(),this.initRender(e,t);const s=this._checkReadiness();return this.finishRender(),s}prepareRenderList(){const e=this._scene;if(this._waitingRenderList){if(!this.renderListPredicate){this.renderList=[];for(let t=0;t<this._waitingRenderList.length;t++){const s=this._waitingRenderList[t],r=e.getMeshById(s);r&&this.renderList.push(r)}}this._waitingRenderList=void 0}if(this.renderListPredicate){this.renderList?this.renderList.length=0:this.renderList=[];const e=this._scene.meshes;for(let t=0;t<e.length;t++){const s=e[t];this.renderListPredicate(s)&&this.renderList.push(s)}}}initRender(e,t){const s=this._scene.getEngine(),r=this.activeCamera??this._scene.activeCamera;this._currentSceneCamera=this._scene.activeCamera,r&&(r!==this._scene.activeCamera&&(this._scene.setTransformMatrix(r.getViewMatrix(),r.getProjectionMatrix(!0)),this._scene.activeCamera=r),s.setViewport(r.rigParent?r.rigParent.viewport:r.viewport,e,t)),this._defaultRenderListPrepared=!1}finishRender(){const e=this._scene;e.activeCamera=this._currentSceneCamera,this._currentSceneCamera&&(this.activeCamera&&this.activeCamera!==e.activeCamera&&e.setTransformMatrix(this._currentSceneCamera.getViewMatrix(),this._currentSceneCamera.getProjectionMatrix(!0)),e.getEngine().setViewport(this._currentSceneCamera.viewport)),e.resetCachedMaterial()}render(e=0,t=!1){const s=this._scene,r=s.getEngine(),i=r.currentRenderPassId;if(r.currentRenderPassId=this._renderPassIds[e],this.onBeforeRenderObservable.notifyObservers(e),r.snapshotRendering&&1===r.snapshotRenderingMode)this.onFastPathRenderObservable.notifyObservers(e);else{let t=null;const r=this.renderList?this.renderList:s.getActiveMeshes().data,i=this.renderList?this.renderList.length:s.getActiveMeshes().length;this.getCustomRenderList&&(t=this.getCustomRenderList(e,r,i)),t?this._prepareRenderingManager(t,t.length,this.forceLayerMaskCheck):(this._defaultRenderListPrepared||(this._prepareRenderingManager(r,i,!this.renderList||this.forceLayerMaskCheck),this._defaultRenderListPrepared=!0),t=r),this.onBeforeRenderingManagerRenderObservable.notifyObservers(e),this._renderingManager.render(this.customRenderFunction,t,this.renderParticles,this.renderSprites),this.onAfterRenderingManagerRenderObservable.notifyObservers(e)}t||this.onAfterRenderObservable.notifyObservers(e),r.currentRenderPassId=i}_checkReadiness(){const e=this._scene,t=e.getEngine(),s=t.currentRenderPassId;let r=!0;e.getViewMatrix()||e.updateTransformMatrix();const i=this.options.numPasses;for(let s=0;s<i&&r;s++){let n=null;const a=this.renderList?this.renderList:e.getActiveMeshes().data,h=this.renderList?this.renderList.length:e.getActiveMeshes().length;t.currentRenderPassId=this._renderPassIds[s],this.onBeforeRenderObservable.notifyObservers(s),this.getCustomRenderList&&(n=this.getCustomRenderList(s,a,h)),n||(n=a),this.options.doNotChangeAspectRatio||e.updateTransformMatrix(!0);for(let e=0;e<n.length&&r;++e){const t=n[e];if(t.isEnabled()&&!t.isBlocked&&t.isVisible&&t.subMeshes)if(this.customIsReadyFunction){if(!this.customIsReadyFunction(t,this.refreshRate,!0)){r=!1;continue}}else if(!t.isReady(!0)){r=!1;continue}}this.onAfterRenderObservable.notifyObservers(s),i>1&&(e.incrementRenderId(),e.resetCachedMaterial())}const n=this.particleSystemList||e.particleSystems;for(const e of n)e.isReady()||(r=!1);return t.currentRenderPassId=s,r}_prepareRenderingManager(e,t,s){const r=this._scene,i=r.activeCamera,n=this.cameraForLOD??i;this._renderingManager.reset();const a=r.getRenderId(),h=r.getFrameId();for(let o=0;o<t;o++){const t=e[o];if(t&&!t.isBlocked){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(t,this.refreshRate,!1)){this.resetRefreshCounter();continue}}else if(!t.isReady(0===this.refreshRate)){this.resetRefreshCounter();continue}let e,o=null;if(n){const e=t._internalAbstractMeshDataInfo._currentLOD.get(n);e&&e[1]===h?o=e[0]:(o=r.customLODSelector?r.customLODSelector(t,n):t.getLOD(n),e?(e[0]=o,e[1]=h):t._internalAbstractMeshDataInfo._currentLOD.set(n,[o,h]))}else o=t;if(!o)continue;if(o!==t&&0!==o.billboardMode&&o.computeWorldMatrix(),o._preActivateForIntermediateRendering(a),e=!(!s||!i||t.layerMask&i.layerMask),t.isEnabled()&&t.isVisible&&t.subMeshes&&!e){if(o!==t&&o._activate(a,!0),t._activate(a,!0)&&t.subMeshes.length){t.isAnInstance?t._internalAbstractMeshDataInfo._actAsRegularMesh&&(o=t):o._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!1,o._internalAbstractMeshDataInfo._isActiveIntermediate=!0,r._prepareSkeleton(o);for(let e=0;e<o.subMeshes.length;e++){const t=o.subMeshes[e];this._renderingManager.dispatch(t,o)}}t._postActivate()}}}const o=this.particleSystemList||r.particleSystems;for(let e=0;e<o.length;e++){const t=o[e],s=t.emitter;t.isStarted()&&s&&(!s.position||s.isEnabled())&&this._renderingManager.dispatchParticles(t)}}setRenderingOrder(e,t=null,s=null,r=null){this._renderingManager.setRenderingOrder(e,t,s,r)}setRenderingAutoClearDepthStencil(e,t,s=!0,r=!0){this._renderingManager.setRenderingAutoClearDepthStencil(e,t,s,r),this._renderingManager._useSceneAutoClearSetup=!1}clone(){const e=new u(this.name,this._scene,this.options);return this.renderList&&(e.renderList=this.renderList.slice(0)),e}dispose(){const e=this.renderList?this.renderList:this._scene.getActiveMeshes().data,t=this.renderList?this.renderList.length:this._scene.getActiveMeshes().length;for(let s=0;s<t;s++){const t=e[s];void 0!==t.getMaterialForRenderPass(this.renderPassId)&&t.setMaterialForRenderPass(this.renderPassId,void 0)}this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderingManagerRenderObservable.clear(),this.onAfterRenderingManagerRenderObservable.clear(),this.onFastPathRenderObservable.clear(),this._releaseRenderPassId(),this.renderList=null}_rebuild(){this.refreshRate===u.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=u.REFRESHRATE_RENDER_ONCE)}freeRenderingGroups(){this._renderingManager&&this._renderingManager.freeRenderingGroups()}}u.REFRESHRATE_RENDER_ONCE=0,u.REFRESHRATE_RENDER_ONEVERYFRAME=1,u.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2,o.M.prototype.setDepthStencilTexture=function(e,t){this._engine.setDepthStencilTexture(this._samplers[e],this._uniforms[e],t,e)};class _ extends n.g{get renderListPredicate(){return this._objectRenderer.renderListPredicate}set renderListPredicate(e){this._objectRenderer.renderListPredicate=e}get renderList(){return this._objectRenderer.renderList}set renderList(e){this._objectRenderer.renderList=e}get particleSystemList(){return this._objectRenderer.particleSystemList}set particleSystemList(e){this._objectRenderer.particleSystemList=e}get getCustomRenderList(){return this._objectRenderer.getCustomRenderList}set getCustomRenderList(e){this._objectRenderer.getCustomRenderList=e}get renderParticles(){return this._objectRenderer.renderParticles}set renderParticles(e){this._objectRenderer.renderParticles=e}get renderSprites(){return this._objectRenderer.renderSprites}set renderSprites(e){this._objectRenderer.renderSprites=e}get forceLayerMaskCheck(){return this._objectRenderer.forceLayerMaskCheck}set forceLayerMaskCheck(e){this._objectRenderer.forceLayerMaskCheck=e}get activeCamera(){return this._objectRenderer.activeCamera}set activeCamera(e){this._objectRenderer.activeCamera=e}get cameraForLOD(){return this._objectRenderer.cameraForLOD}set cameraForLOD(e){this._objectRenderer.cameraForLOD=e}get customIsReadyFunction(){return this._objectRenderer.customIsReadyFunction}set customIsReadyFunction(e){this._objectRenderer.customIsReadyFunction=e}get customRenderFunction(){return this._objectRenderer.customRenderFunction}set customRenderFunction(e){this._objectRenderer.customRenderFunction=e}get postProcesses(){return this._postProcesses}get _prePassEnabled(){return!!this._prePassRenderTarget&&this._prePassRenderTarget.enabled}set onAfterUnbind(e){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(e)}get onBeforeRenderObservable(){return this._objectRenderer.onBeforeRenderObservable}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}get onAfterRenderObservable(){return this._objectRenderer.onAfterRenderObservable}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}set onClear(e){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(e)}get _waitingRenderList(){return this._objectRenderer._waitingRenderList}set _waitingRenderList(e){this._objectRenderer._waitingRenderList=e}get renderPassId(){return this._objectRenderer.renderPassId}get renderPassIds(){return this._objectRenderer.renderPassIds}get currentRefreshId(){return this._objectRenderer.currentRefreshId}setMaterialForRendering(e,t){this._objectRenderer.setMaterialForRendering(e,t)}get isMulti(){return this._renderTarget?.isMulti??!1}get renderTargetOptions(){return this._renderTargetOptions}get renderTarget(){return this._renderTarget}_onRatioRescale(){this._sizeRatio&&this.resize(this._initialSizeParameter)}set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}get depthStencilTexture(){return this._renderTarget?._depthStencilTexture??null}constructor(e,t,s,a=!1,h=!0,o=0,c=!1,l=n.g.TRILINEAR_SAMPLINGMODE,_=!0,p=!1,f=!1,g=5,b=!1,m,R,v=!1,S=!1){let P,O,C=!0;if("object"==typeof a){const e=a;a=!!e.generateMipMaps,h=e.doNotChangeAspectRatio??!0,o=e.type??0,c=!!e.isCube,l=e.samplingMode??n.g.TRILINEAR_SAMPLINGMODE,_=e.generateDepthBuffer??!0,p=!!e.generateStencilBuffer,f=!!e.isMulti,g=e.format??5,b=!!e.delayAllocation,m=e.samples,R=e.creationFlags,v=!!e.noColorAttachment,S=!!e.useSRGBBuffer,P=e.colorAttachment,C=e.gammaSpace??C,O=e.existingObjectRenderer}if(super(null,s,!a,void 0,l,void 0,void 0,void 0,void 0,g),this.ignoreCameraViewport=!1,this.onBeforeBindObservable=new r.cP,this.onAfterUnbindObservable=new r.cP,this.onClearObservable=new r.cP,this.onResizeObservable=new r.cP,this._cleared=!1,this.skipInitialClear=!1,this._samples=1,this._canRescale=!0,this._renderTarget=null,this._dontDisposeObjectRenderer=!1,this.boundingBoxPosition=i.Pq.Zero(),this._disableEngineStages=!1,this._dumpToolsLoading=!1,!(s=this.getScene()))return;const x=this.getScene().getEngine();this._gammaSpace=C,this._coordinatesMode=n.g.PROJECTION_MODE,this.name=e,this.isRenderTarget=!0,this._initialSizeParameter=t,this._dontDisposeObjectRenderer=!!O,this._processSizeParameter(t),this._objectRenderer=O??new u(e,s,{numPasses:c?6:this.getRenderLayers()||1,doNotChangeAspectRatio:h}),this._onBeforeRenderingManagerRenderObserver=this._objectRenderer.onBeforeRenderingManagerRenderObservable.add((()=>{if(!this._disableEngineStages)for(const e of this._scene._beforeRenderTargetClearStage)e.action(this,this._currentFaceIndex,this._currentLayer);if(this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(x):this.skipInitialClear||x.clear(this.clearColor||this._scene.clearColor,!0,!0,!0),this._doNotChangeAspectRatio||this._scene.updateTransformMatrix(!0),!this._disableEngineStages)for(const e of this._scene._beforeRenderTargetDrawStage)e.action(this,this._currentFaceIndex,this._currentLayer)})),this._onAfterRenderingManagerRenderObserver=this._objectRenderer.onAfterRenderingManagerRenderObservable.add((()=>{if(!this._disableEngineStages)for(const e of this._scene._afterRenderTargetDrawStage)e.action(this,this._currentFaceIndex,this._currentLayer);const e=this._texture?.generateMipMaps??!1;if(this._texture&&(this._texture.generateMipMaps=!1),this._postProcessManager?this._postProcessManager._finalizeFrame(!1,this._renderTarget??void 0,this._currentFaceIndex,this._postProcesses,this.ignoreCameraViewport):this._currentUseCameraPostProcess&&this._scene.postProcessManager._finalizeFrame(!1,this._renderTarget??void 0,this._currentFaceIndex),!this._disableEngineStages)for(const e of this._scene._afterRenderTargetPostProcessStage)e.action(this,this._currentFaceIndex,this._currentLayer);this._texture&&(this._texture.generateMipMaps=e),this._doNotChangeAspectRatio||this._scene.updateTransformMatrix(!0),this._currentDumpForDebug&&(this._dumpTools?this._dumpTools.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),x):d.V.Error("dumpTools module is still being loaded. To speed up the process import dump tools directly in your project"))})),this._onFastPathRenderObserver=this._objectRenderer.onFastPathRenderObservable.add((()=>{this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(x):this.skipInitialClear||x.clear(this.clearColor||this._scene.clearColor,!0,!0,!0)})),this._resizeObserver=x.onResizeObservable.add((()=>{})),this._generateMipMaps=!!a,this._doNotChangeAspectRatio=h,f||(this._renderTargetOptions={generateMipMaps:a,type:o,format:this._format??void 0,samplingMode:this.samplingMode,generateDepthBuffer:_,generateStencilBuffer:p,samples:m,creationFlags:R,noColorAttachment:v,useSRGBBuffer:S,colorAttachment:P,label:this.name},this.samplingMode===n.g.NEAREST_SAMPLINGMODE&&(this.wrapU=n.g.CLAMP_ADDRESSMODE,this.wrapV=n.g.CLAMP_ADDRESSMODE),b||(c?(this._renderTarget=s.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions),this.coordinatesMode=n.g.INVCUBIC_MODE,this._textureMatrix=i.uq.Identity()):this._renderTarget=s.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==m&&(this.samples=m)))}createDepthStencilTexture(e=0,t=!0,s=!1,r=1,i=14,n){this._renderTarget?.createDepthStencilTexture(e,t,s,r,i,n)}_processSizeParameter(e){if(e.ratio){this._sizeRatio=e.ratio;const t=this._getEngine();this._size={width:this._bestReflectionRenderTargetDimension(t.getRenderWidth(),this._sizeRatio),height:this._bestReflectionRenderTargetDimension(t.getRenderHeight(),this._sizeRatio)}}else this._size=e}get samples(){return this._renderTarget?.samples??this._samples}set samples(e){this._renderTarget&&(this._samples=this._renderTarget.setSamples(e))}addPostProcess(e){if(!this._postProcessManager){const e=this.getScene();if(!e)return;this._postProcessManager=new a.X(e),this._postProcesses=new Array}this._postProcesses.push(e),this._postProcesses[0].autoClear=!1}clearPostProcesses(e=!1){if(this._postProcesses){if(e)for(const e of this._postProcesses)e.dispose();this._postProcesses=[]}}removePostProcess(e){if(!this._postProcesses)return;const t=this._postProcesses.indexOf(e);-1!==t&&(this._postProcesses.splice(t,1),this._postProcesses.length>0&&(this._postProcesses[0].autoClear=!1))}resetRefreshCounter(){this._objectRenderer.resetRefreshCounter()}get refreshRate(){return this._objectRenderer.refreshRate}set refreshRate(e){this._objectRenderer.refreshRate=e}_shouldRender(){return this._objectRenderer.shouldRender()}getRenderSize(){return this.getRenderWidth()}getRenderWidth(){return this._size.width?this._size.width:this._size}getRenderHeight(){return this._size.width?this._size.height:this._size}getRenderLayers(){const e=this._size.layers;if(e)return e;return this._size.depth||0}disableRescaling(){this._canRescale=!1}get canRescale(){return this._canRescale}scale(e){const t=Math.max(1,this.getRenderSize()*e);this.resize(t)}getReflectionTextureMatrix(){return this.isCube?this._textureMatrix:super.getReflectionTextureMatrix()}resize(e){const t=this.isCube;this._renderTarget?.dispose(),this._renderTarget=null;const s=this.getScene();s&&(this._processSizeParameter(e),this._renderTarget=t?s.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions):s.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==this._renderTargetOptions.samples&&(this.samples=this._renderTargetOptions.samples),this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this))}render(e=!1,t=!1){this._render(e,t)}isReadyForRendering(){this._dumpToolsLoading||(this._dumpToolsLoading=!0,Promise.all([s.e(998),s.e(9928)]).then(s.bind(s,9928)).then((e=>this._dumpTools=e))),this._objectRenderer.prepareRenderList(),this.onBeforeBindObservable.notifyObservers(this),this._objectRenderer.initRender(this.getRenderWidth(),this.getRenderHeight());const e=this._objectRenderer._checkReadiness();return this.onAfterUnbindObservable.notifyObservers(this),this._objectRenderer.finishRender(),e}_render(e=!1,t=!1){const s=this.getScene();if(s){if(void 0!==this.useCameraPostProcesses&&(e=this.useCameraPostProcesses),this._objectRenderer.prepareRenderList(),this.onBeforeBindObservable.notifyObservers(this),this._objectRenderer.initRender(this.getRenderWidth(),this.getRenderHeight()),!this.is2DArray&&!this.is3D||this.isMulti)if(this.isCube&&!this.isMulti)for(let r=0;r<6;r++)this._renderToTarget(r,e,t),s.incrementRenderId(),s.resetCachedMaterial();else this._renderToTarget(0,e,t);else for(let r=0;r<this.getRenderLayers();r++)this._renderToTarget(0,e,t,r),s.incrementRenderId(),s.resetCachedMaterial();this.onAfterUnbindObservable.notifyObservers(this),this._objectRenderer.finishRender()}}_bestReflectionRenderTargetDimension(e,t){const s=e*t,r=(0,h.OG)(s+16384/(128+s));return Math.min((0,h.C4)(e),r)}_bindFrameBuffer(e=0,t=0){const s=this.getScene();if(!s)return;const r=s.getEngine();this._renderTarget&&r.bindFramebuffer(this._renderTarget,this.isCube?e:void 0,void 0,void 0,this.ignoreCameraViewport,0,t)}_unbindFrameBuffer(e,t){this._renderTarget&&e.unBindFramebuffer(this._renderTarget,this.isCube,(()=>{this.onAfterRenderObservable.notifyObservers(t)}))}_prepareFrame(e,t,s,r){this._postProcessManager?this._prePassEnabled||this._postProcessManager._prepareFrame(this._texture,this._postProcesses):r&&e.postProcessManager._prepareFrame(this._texture)||this._bindFrameBuffer(t,s)}_renderToTarget(e,t,s,r=0){const i=this.getScene();if(!i)return;const n=i.getEngine();this._currentFaceIndex=e,this._currentLayer=r,this._currentUseCameraPostProcess=t,this._currentDumpForDebug=s,this._prepareFrame(i,e,r,t),n._debugPushGroup?.(`render to face #${e} layer #${r}`,2),this._objectRenderer.render(e+r,!0),n._debugPopGroup?.(2),this._unbindFrameBuffer(n,e),this._texture&&this.isCube&&5===e&&n.generateMipMapsForCubemap(this._texture,!0)}setRenderingOrder(e,t=null,s=null,r=null){this._objectRenderer.setRenderingOrder(e,t,s,r)}setRenderingAutoClearDepthStencil(e,t){this._objectRenderer.setRenderingAutoClearDepthStencil(e,t)}clone(){const e=this.getSize(),t=new _(this.name,e,this.getScene(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer,void 0,this._renderTargetOptions.format,void 0,this._renderTargetOptions.samples);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,this.renderList&&(t.renderList=this.renderList.slice(0)),t}serialize(){if(!this.name)return null;const e=super.serialize();if(e.renderTargetSize=this.getRenderSize(),e.renderList=[],this.renderList)for(let t=0;t<this.renderList.length;t++)e.renderList.push(this.renderList[t].id);return e}disposeFramebufferObjects(){this._renderTarget?.dispose(!0)}releaseInternalTexture(){this._renderTarget?.releaseTextures(),this._texture=null}dispose(){this.onResizeObservable.clear(),this.onClearObservable.clear(),this.onAfterUnbindObservable.clear(),this.onBeforeBindObservable.clear(),this._postProcessManager&&(this._postProcessManager.dispose(),this._postProcessManager=null),this._prePassRenderTarget&&this._prePassRenderTarget.dispose(),this._objectRenderer.onBeforeRenderingManagerRenderObservable.remove(this._onBeforeRenderingManagerRenderObserver),this._objectRenderer.onAfterRenderingManagerRenderObservable.remove(this._onAfterRenderingManagerRenderObserver),this._objectRenderer.onFastPathRenderObservable.remove(this._onFastPathRenderObserver),this._dontDisposeObjectRenderer||this._objectRenderer.dispose(),this.clearPostProcesses(!0),this._resizeObserver&&(this.getScene().getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null);const e=this.getScene();if(!e)return;let t=e.customRenderTargets.indexOf(this);t>=0&&e.customRenderTargets.splice(t,1);for(const s of e.cameras)t=s.customRenderTargets.indexOf(this),t>=0&&s.customRenderTargets.splice(t,1);this._renderTarget?.dispose(),this._renderTarget=null,this._texture=null,super.dispose()}_rebuild(){this._objectRenderer._rebuild(),this._postProcessManager&&this._postProcessManager._rebuild()}freeRenderingGroups(){this._objectRenderer.freeRenderingGroups()}getViewCount(){return 1}}_.REFRESHRATE_RENDER_ONCE=u.REFRESHRATE_RENDER_ONCE,_.REFRESHRATE_RENDER_ONEVERYFRAME=u.REFRESHRATE_RENDER_ONEVERYFRAME,_.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=u.REFRESHRATE_RENDER_ONEVERYTWOFRAMES,n.g._CreateRenderTargetTexture=(e,t,s,r,i)=>new _(e,t,s,r)},7891:(e,t,s)=>{s.d(t,{w:()=>p});var r=s(5524),i=s(7931),n=s(9848),a=s(9923),h=s(4420),o=s(9259),d=s(6877),c=s(6552),l=s(6326),u=s(1597),_=s(4255);l.$.prototype.setTextureFromPostProcess=function(e,t,s){let r=null;t&&(t._forcedOutputTexture?r=t._forcedOutputTexture:t._textures.data[t._currentRenderTextureInd]&&(r=t._textures.data[t._currentRenderTextureInd])),this._bindTexture(e,r?.texture??null,s)},l.$.prototype.setTextureFromPostProcessOutput=function(e,t,s){this._bindTexture(e,t?._outputTexture?.texture??null,s)},h.M.prototype.setTextureFromPostProcess=function(e,t){this._engine.setTextureFromPostProcess(this._samplers[e],t,e)},h.M.prototype.setTextureFromPostProcessOutput=function(e,t){this._engine.setTextureFromPostProcessOutput(this._samplers[e],t,e)};class p{static get ForceGLSL(){return _.$.ForceGLSL}static set ForceGLSL(e){_.$.ForceGLSL=e}static RegisterShaderCodeProcessing(e,t){_.$.RegisterShaderCodeProcessing(e,t)}get name(){return this._effectWrapper.name}set name(e){this._effectWrapper.name=e}get alphaMode(){return this._effectWrapper.alphaMode}set alphaMode(e){this._effectWrapper.alphaMode=e}get samples(){return this._samples}set samples(e){this._samples=Math.min(e,this._engine.getCaps().maxMSAASamples),this._textures.forEach((e=>{e.setSamples(this._samples)}))}get shaderLanguage(){return this._shaderLanguage}getEffectName(){return this._fragmentUrl}set onActivate(e){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),e&&(this._onActivateObserver=this.onActivateObservable.add(e))}set onSizeChanged(e){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(e)}set onApply(e){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(e)}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}get inputTexture(){return this._textures.data[this._currentRenderTextureInd]}set inputTexture(e){this._forcedOutputTexture=e}restoreDefaultInputTexture(){this._forcedOutputTexture&&(this._forcedOutputTexture=null,this.markTextureDirty())}getCamera(){return this._camera}get texelSize(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.copyFromFloats(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)}constructor(e,t,s,r,h,o,d=1,c,l,u=null,f=0,g="postprocess",b,m=!1,R=5,v,S){this._parentContainer=null,this.width=-1,this.height=-1,this.nodeMaterialSource=null,this._outputTexture=null,this.autoClear=!0,this.forceAutoClearInAlphaMode=!1,this.animations=[],this.enablePixelPerfectMode=!1,this.forceFullscreenViewport=!0,this.scaleMode=1,this.alwaysForcePOT=!1,this._samples=1,this.adaptScaleToCurrentViewport=!1,this._webGPUReady=!1,this._reusable=!1,this._renderId=0,this.externalTextureSamplerBinding=!1,this._textures=new i.L(2),this._textureCache=[],this._currentRenderTextureInd=0,this._scaleRatio=new a.I9(1,1),this._texelSize=a.I9.Zero(),this.onActivateObservable=new n.cP,this.onSizeChangedObservable=new n.cP,this.onApplyObservable=new n.cP,this.onBeforeRenderObservable=new n.cP,this.onAfterRenderObservable=new n.cP;let P,O=1,C=null;if(s&&!Array.isArray(s)){const e=s;s=e.uniforms??null,r=e.samplers??null,O=e.size??1,o=e.camera??null,d=e.samplingMode??1,c=e.engine,l=e.reusable,u=Array.isArray(e.defines)?e.defines.join("\n"):e.defines??null,f=e.textureType??0,g=e.vertexUrl??"postprocess",b=e.indexParameters,m=e.blockCompilation??!1,R=e.textureFormat??5,v=e.shaderLanguage??0,C=e.uniformBuffers??null,S=e.extraInitializations,P=e.effectWrapper}else h&&(O="number"==typeof h?h:{width:h.width,height:h.height});const x=!!P;if(this._effectWrapper=P??new _.$({name:e,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:t,engine:c||o?.getScene().getEngine(),uniforms:s,samplers:r,uniformBuffers:C,defines:u,vertexUrl:g,indexParameters:b,blockCompilation:!0,shaderLanguage:v,extraInitializations:void 0}),this.name=e,this.onEffectCreatedObservable=this._effectWrapper.onEffectCreatedObservable,null!=o?(this._camera=o,this._scene=o.getScene(),o.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.postProcesses.push(this),this.uniqueId=this._scene.getUniqueId()):c&&(this._engine=c,this._engine.postProcesses.push(this)),this._options=O,this.renderTargetSamplingMode=d||1,this._reusable=l||!1,this._textureType=f,this._textureFormat=R,this._shaderLanguage=v||0,this._samplers=r||[],-1===this._samplers.indexOf("textureSampler")&&this._samplers.push("textureSampler"),this._fragmentUrl=t,this._vertexUrl=g,this._parameters=s||[],-1===this._parameters.indexOf("scale")&&this._parameters.push("scale"),this._uniformBuffers=C||[],this._indexParameters=b,!x){this._webGPUReady=1===this._shaderLanguage;const e=[];this._gatherImports(this._engine.isWebGPU&&!p.ForceGLSL,e),this._effectWrapper._webGPUReady=this._webGPUReady,this._effectWrapper._postConstructor(m,u,S,e)}}_gatherImports(e=!1,t){e&&this._webGPUReady?t.push(Promise.all([s.e(3126).then(s.bind(s,2083))])):t.push(Promise.all([Promise.resolve().then(s.bind(s,6612))]))}getClassName(){return"PostProcess"}getEngine(){return this._engine}getEffect(){return this._effectWrapper.drawWrapper.effect}shareOutputWith(e){return this._disposeTextures(),this._shareOutputWithPostProcess=e,this}useOwnOutput(){0==this._textures.length&&(this._textures=new i.L(2)),this._shareOutputWithPostProcess=null}updateEffect(e=null,t=null,s=null,r,i,n,a,h){this._effectWrapper.updateEffect(e,t,s,r,i,n,a,h),this._postProcessDefines=Array.isArray(this._effectWrapper.options.defines)?this._effectWrapper.options.defines.join("\n"):this._effectWrapper.options.defines}isReusable(){return this._reusable}markTextureDirty(){this.width=-1}_createRenderTargetTexture(e,t,s=0){for(let r=0;r<this._textureCache.length;r++)if(this._textureCache[r].texture.width===e.width&&this._textureCache[r].texture.height===e.height&&this._textureCache[r].postProcessChannel===s&&this._textureCache[r].texture._generateDepthBuffer===t.generateDepthBuffer&&this._textureCache[r].texture.samples===t.samples)return this._textureCache[r].texture;const r=this._engine.createRenderTargetTexture(e,t);return this._textureCache.push({texture:r,postProcessChannel:s,lastUsedRenderId:-1}),r}_flushTextureCache(){const e=this._renderId;for(let t=this._textureCache.length-1;t>=0;t--)if(e-this._textureCache[t].lastUsedRenderId>100){let e=!1;for(let s=0;s<this._textures.length;s++)if(this._textures.data[s]===this._textureCache[t].texture){e=!0;break}e||(this._textureCache[t].texture.dispose(),this._textureCache.splice(t,1))}}resize(e,t,s=null,r=!1,i=!1){this._textures.length>0&&this._textures.reset(),this.width=e,this.height=t;let n=null;if(s)for(let e=0;e<s._postProcesses.length;e++)if(null!==s._postProcesses[e]){n=s._postProcesses[e];break}const a={width:this.width,height:this.height},h={generateMipMaps:r,generateDepthBuffer:i||n===this,generateStencilBuffer:(i||n===this)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType,format:this._textureFormat,samples:this._samples,label:"PostProcessRTT-"+this.name};this._textures.push(this._createRenderTargetTexture(a,h,0)),this._reusable&&this._textures.push(this._createRenderTargetTexture(a,h,1)),this._texelSize.copyFromFloats(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)}_getTarget(){let e;if(this._shareOutputWithPostProcess)e=this._shareOutputWithPostProcess.inputTexture;else if(this._forcedOutputTexture)e=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height;else{let t;e=this.inputTexture;for(let s=0;s<this._textureCache.length;s++)if(this._textureCache[s].texture===e){t=this._textureCache[s];break}t&&(t.lastUsedRenderId=this._renderId)}return e}activate(e,t=null,s){const r=null===e||void 0!==e.cameraRigMode?e||this._camera:null,i=r?.getScene()??e,n=i.getEngine(),a=n.getCaps().maxTextureSize,h=(t?t.width:this._engine.getRenderWidth(!0))*this._options|0,o=(t?t.height:this._engine.getRenderHeight(!0))*this._options|0;let d=this._options.width||h,c=this._options.height||o;const l=7!==this.renderTargetSamplingMode&&1!==this.renderTargetSamplingMode&&2!==this.renderTargetSamplingMode;let _=null;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){const e=n.currentViewport;e&&(d*=e.width,c*=e.height)}(l||this.alwaysForcePOT)&&(this._options.width||(d=n.needPOTTextures?(0,u.R)(d,a,this.scaleMode):d),this._options.height||(c=n.needPOTTextures?(0,u.R)(c,a,this.scaleMode):c)),this.width===d&&this.height===c&&(_=this._getTarget())||this.resize(d,c,r,l,s),this._textures.forEach((e=>{e.samples!==this.samples&&this._engine.updateRenderTargetTextureSampleCount(e,this.samples)})),this._flushTextureCache(),this._renderId++}return _||(_=this._getTarget()),this.enablePixelPerfectMode?(this._scaleRatio.copyFromFloats(h/d,o/c),this._engine.bindFramebuffer(_,0,h,o,this.forceFullscreenViewport)):(this._scaleRatio.copyFromFloats(1,1),this._engine.bindFramebuffer(_,0,void 0,void 0,this.forceFullscreenViewport)),this._engine._debugInsertMarker?.(`post process ${this.name} input`),this.onActivateObservable.notifyObservers(r),this.autoClear&&(0===this.alphaMode||this.forceAutoClearInAlphaMode)&&this._engine.clear(this.clearColor?this.clearColor:i.clearColor,i._allowPostProcessClearColor,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),_}get isSupported(){return this._effectWrapper.drawWrapper.effect.isSupported}get aspectRatio(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height}isReady(){return this._effectWrapper.isReady()}apply(){if(!this._effectWrapper.isReady())return null;let e;return this._engine.enableEffect(this._effectWrapper.drawWrapper),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a),e=this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?this._forcedOutputTexture:this.inputTexture,this.externalTextureSamplerBinding||this._effectWrapper.drawWrapper.effect._bindTexture("textureSampler",e?.texture),this._effectWrapper.drawWrapper.effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._effectWrapper.drawWrapper.effect),this._effectWrapper.bind(),this._effectWrapper.drawWrapper.effect}_disposeTextures(){this._shareOutputWithPostProcess||this._forcedOutputTexture?this._disposeTextureCache():(this._disposeTextureCache(),this._textures.dispose())}_disposeTextureCache(){for(let e=this._textureCache.length-1;e>=0;e--)this._textureCache[e].texture.dispose();this._textureCache.length=0}setPrePassRenderer(e){return!!this._prePassEffectConfiguration&&(this._prePassEffectConfiguration=e.addEffectConfiguration(this._prePassEffectConfiguration),this._prePassEffectConfiguration.enabled=!0,!0)}dispose(e){let t;if(e=e||this._camera,this._disposeTextures(),this._scene&&(t=this._scene.postProcesses.indexOf(this),-1!==t&&this._scene.postProcesses.splice(t,1)),this._parentContainer){const e=this._parentContainer.postProcesses.indexOf(this);e>-1&&this._parentContainer.postProcesses.splice(e,1),this._parentContainer=null}if(t=this._engine.postProcesses.indexOf(this),-1!==t&&this._engine.postProcesses.splice(t,1),e){if(e.detachPostProcess(this),t=e._postProcesses.indexOf(this),0===t&&e._postProcesses.length>0){const e=this._camera._getFirstPostProcess();e&&e.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear(),this.onEffectCreatedObservable.clear()}}serialize(){const e=d.p.Serialize(this),t=this.getCamera()||this._scene&&this._scene.activeCamera;return e.customType="BABYLON."+this.getClassName(),e.cameraId=t?t.id:null,e.reusable=this._reusable,e.textureType=this._textureType,e.fragmentUrl=this._fragmentUrl,e.parameters=this._parameters,e.samplers=this._samplers,e.uniformBuffers=this._uniformBuffers,e.options=this._options,e.defines=this._postProcessDefines,e.textureFormat=this._textureFormat,e.vertexUrl=this._vertexUrl,e.indexParameters=this._indexParameters,e}clone(){const e=this.serialize();e._engine=this._engine,e.cameraId=null;const t=p.Parse(e,this._scene,"");return t?(t.onActivateObservable=this.onActivateObservable.clone(),t.onSizeChangedObservable=this.onSizeChangedObservable.clone(),t.onApplyObservable=this.onApplyObservable.clone(),t.onBeforeRenderObservable=this.onBeforeRenderObservable.clone(),t.onAfterRenderObservable=this.onAfterRenderObservable.clone(),t._prePassEffectConfiguration=this._prePassEffectConfiguration,t):null}static Parse(e,t,s){const r=(0,c.n9)(e.customType);if(!r||!r._Parse)return null;const i=t?t.getCameraById(e.cameraId):null;return r._Parse(e,i,t,s)}static _Parse(e,t,s,r){return d.p.Parse((()=>new p(e.name,e.fragmentUrl,e.parameters,e.samplers,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable,e.defines,e.textureType,e.vertexUrl,e.indexParameters,!1,e.textureFormat)),e,s,r)}}(0,r.Cg)([(0,o.lK)()],p.prototype,"uniqueId",void 0),(0,r.Cg)([(0,o.lK)()],p.prototype,"name",null),(0,r.Cg)([(0,o.lK)()],p.prototype,"width",void 0),(0,r.Cg)([(0,o.lK)()],p.prototype,"height",void 0),(0,r.Cg)([(0,o.lK)()],p.prototype,"renderTargetSamplingMode",void 0),(0,r.Cg)([(0,o.qK)()],p.prototype,"clearColor",void 0),(0,r.Cg)([(0,o.lK)()],p.prototype,"autoClear",void 0),(0,r.Cg)([(0,o.lK)()],p.prototype,"forceAutoClearInAlphaMode",void 0),(0,r.Cg)([(0,o.lK)()],p.prototype,"alphaMode",null),(0,r.Cg)([(0,o.lK)()],p.prototype,"alphaConstants",void 0),(0,r.Cg)([(0,o.lK)()],p.prototype,"enablePixelPerfectMode",void 0),(0,r.Cg)([(0,o.lK)()],p.prototype,"forceFullscreenViewport",void 0),(0,r.Cg)([(0,o.lK)()],p.prototype,"scaleMode",void 0),(0,r.Cg)([(0,o.lK)()],p.prototype,"alwaysForcePOT",void 0),(0,r.Cg)([(0,o.lK)("samples")],p.prototype,"_samples",void 0),(0,r.Cg)([(0,o.lK)()],p.prototype,"adaptScaleToCurrentViewport",void 0),(0,c.Y5)("BABYLON.PostProcess",p)},7931:(e,t,s)=>{s.d(t,{L:()=>r,b:()=>i});class r{constructor(e){this.length=0,this.data=new Array(e),this._id=r._GlobalId++}push(e){this.data[this.length++]=e,this.length>this.data.length&&(this.data.length*=2)}forEach(e){for(let t=0;t<this.length;t++)e(this.data[t])}sort(e){this.data.sort(e)}reset(){this.length=0}dispose(){this.reset(),this.data&&(this.data.length=0)}concat(e){if(0!==e.length){this.length+e.length>this.data.length&&(this.data.length=2*(this.length+e.length));for(let t=0;t<e.length;t++)this.data[this.length++]=(e.data||e)[t]}}indexOf(e){const t=this.data.indexOf(e);return t>=this.length?-1:t}contains(e){return-1!==this.indexOf(e)}}r._GlobalId=0;class i extends r{constructor(){super(...arguments),this._duplicateId=0}push(e){super.push(e),e.__smartArrayFlags||(e.__smartArrayFlags={}),e.__smartArrayFlags[this._id]=this._duplicateId}pushNoDuplicate(e){return!(e.__smartArrayFlags&&e.__smartArrayFlags[this._id]===this._duplicateId||(this.push(e),0))}reset(){super.reset(),this._duplicateId++}concatWithNoDuplicate(e){if(0!==e.length){this.length+e.length>this.data.length&&(this.data.length=2*(this.length+e.length));for(let t=0;t<e.length;t++){const s=(e.data||e)[t];this.pushNoDuplicate(s)}}}}}}]);