"use strict";(self.webpackChunkbabylon_bulletphysics=self.webpackChunkbabylon_bulletphysics||[]).push([[5499],{2399:(e,n,t)=>{t.d(n,{q:()=>o});class o{_a;constructor(e){this._a=e}next(){let e=this._a+=1831565813;return e=Math.imul(e^e>>>15,1|e),e^=e+Math.imul(e^e>>>7,61|e),((e^e>>>14)>>>0)/4294967296}}},5499:(e,n,t)=>{t.r(n),t.d(n,{SceneBuilder:()=>I}),t(203),t(1440),t(1503),t(8227);var o=t(7456),a=t(5581),s=t(1513),r=t(9711),i=t(6041),c=t(9923),l=t(9899),u=t(8144),w=t(8121),d=t(554),p=t(6738),h=t(7168),f=t(2090),m=t(7744),g=t(1167),T=t(5733),b=t(6405),y=t(1592),x=t(7648),P=t(5901),q=t(3477),S=t(9800),R=t(2399);class I{async build(e,n){const t=new d.Z(n);t.clearColor=new i.ov(.95,.95,.95,1);const I=new o.Lq("arcRotateCamera",0,0,500,new c.Pq(0,0,0),t);I.minZ=1,I.maxZ=3e3,I.setPosition(new c.Pq(60,40,-50).scaleInPlace(10)),I.attachControl(void 0,!1),I.inertia=.8,I.speed=10;const L=new s.g("hemisphericLight",new c.Pq(0,1,0),t);L.intensity=.5,L.specular=new i.v9(0,0,0),L.groundColor=new i.v9(1,1,1);const C=new a.Z("directionalLight",new c.Pq(.5,-1,1),t);C.intensity=.5;C.shadowMaxZ=250,C.shadowMinZ=-250,C.autoCalcShadowZBounds=!1,C.autoUpdateExtends=!1,C.shadowOrthoScale=0,C.orthoTop=250,C.orthoBottom=-250,C.orthoLeft=-250,C.orthoRight=250;const M=new r.o(2048,C,!0);M.transparencyShadow=!0,M.usePercentageCloserFiltering=!0,M.forceBackFacesOnly=!1,M.bias=.004,M.filteringQuality=r.o.QUALITY_MEDIUM;const v=parseInt(prompt("Thread count","2"));console.log("Thread count:",v);const B=1===v?await(0,p.e)(new g.Z):await(0,p.e)(new m.t,v),F=new f.D(B),Q=new T.F(F,!0),Z=new c.uq;{const e=(0,u.x)("ground",{size:500},t);e.rotationQuaternion=c.PT.RotationAxis(new c.Pq(1,0,0),Math.PI/2),M.addShadowCaster(e),e.receiveShadows=!0;const n=new b.Ty(F,new c.Pq(0,0,-1),0),o=new P.t(B);o.shape=n,c.uq.FromQuaternionToRef(e.rotationQuaternion,Z),o.setInitialTransform(Z),o.motionType=1;const a=new y.U(F,o);Q.addRigidBodyToGlobal(a)}const A=512,_=[],U=[];if("u"===prompt("Shape type (u, r) uniform box, random","u")){const e=new c.Pq(1,1,1),n=new b.SA(F,e),t={type:"box",size:e};for(let e=0;e<A;++e)_.push(n),U.push(t)}else{const e=new R.q(0);for(let n=0;n<A;++n){const n=2*e.next()|0;if(0===n){const n=2*e.next()+.5,t=2*e.next()+.5,o=2*e.next()+.5,a=new c.Pq(n,t,o);_.push(new b.SA(F,a)),U.push({type:"box",size:a})}else{if(1!==n)throw new Error("Invalid type");{const n=2*e.next()+1;_.push(new b.O4(F,n)),U.push({type:"sphere",radius:n})}}}}const k=[];for(let e=0;e<4;++e)for(let n=0;n<8;++n){const t=8*e+n,o=60*(n-4)+30,a=60*(e-2)+30,s=new q.x(B,A);for(let e=0;e<A;++e){s.setShape(e,_[e]);const n=c.uq.TranslationToRef(o,1+2*e,a,Z);s.setInitialTransform(e,n),s.setFriction(e,1),s.setLinearDamping(e,.3),s.setAngularDamping(e,.3)}const r=new x.Y(F,s);Q.addRigidBodyBundle(r,t);for(let e=0;e<A;e+=2){const n=[e,e+1],o=new h.vC(F,r,n,c.uq.Translation(0,-1.2,0),c.uq.Translation(0,1.2,0),!0);o.setLinearLowerLimit(new c.Pq(0,0,0)),o.setLinearUpperLimit(new c.Pq(0,0,0)),o.setAngularLowerLimit(new c.Pq(Math.PI/4,0,0)),o.setAngularUpperLimit(new c.Pq(0,0,0));for(let e=0;e<6;++e)o.enableSpring(e,!0),o.setStiffness(e,100),o.setDamping(e,1);Q.addConstraint(o,t,!0)}k.push(r)}console.log("Rigid body count:",16384);const z=[],D=(0,l.an)("baseBox",{size:1},t),E=(0,w._6)("baseSphere",{diameter:1},t);D.setEnabled(!1),E.setEnabled(!1),D.receiveShadows=!0,E.receiveShadows=!0;for(let e=0;e<16384;++e){const n=U[e%U.length],t="box"===n.type?D.createInstance(`boxInstance${e}`):E.createInstance(`sphereInstance${e}`);M.addShadowCaster(t),t.scaling.copyFrom("box"===n.type?n.size.scale(2):new c.Pq(n.radius,n.radius,n.radius).scale(2)),t.rotationQuaternion=c.PT.Identity(),z.push(t)}return new S.X((()=>{const e=performance.now();Q.stepSimulation(1/60,10,1/60);for(let e=0;e<k.length;++e){const n=k[e];for(let t=0;t<A;++t){n.getTransformMatrixToRef(t,Z);const o=z[e*A+t];Z.getTranslationToRef(o.position),c.PT.FromRotationMatrixToRef(Z,o.rotationQuaternion)}}const n=performance.now(),o=n-e;return t.render(),[o,performance.now()-n]})).runBench(),t.onBeforeRenderObservable.add((()=>{Q.stepSimulation(1/60,10,1/60);for(let e=0;e<k.length;++e){const n=k[e];for(let t=0;t<A;++t){n.getTransformMatrixToRef(t,Z);const o=z[e*A+t];Z.getTranslationToRef(o.position),c.PT.FromRotationMatrixToRef(Z,o.rotationQuaternion)}}})),t}}}}]);