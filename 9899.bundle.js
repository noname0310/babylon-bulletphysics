"use strict";(self.webpackChunkbabylon_bulletphysics=self.webpackChunkbabylon_bulletphysics||[]).push([[9899],{9899:(i,s,t)=>{t.d(s,{an:()=>_});var e=t(9923),o=t(6041),n=t(1812),h=t(6803),r=t(1313),a=t(5616);n.e._GroundMeshParser=(i,s)=>u.Parse(i,s);class u extends n.e{constructor(i,s){super(i,s),this.generateOctree=!1}getClassName(){return"GroundMesh"}get subdivisions(){return Math.min(this._subdivisionsX,this._subdivisionsY)}get subdivisionsX(){return this._subdivisionsX}get subdivisionsY(){return this._subdivisionsY}optimize(i,s=32){this._subdivisionsX=i,this._subdivisionsY=i,this.subdivide(i);this.createOrUpdateSubmeshesOctree&&this.createOrUpdateSubmeshesOctree(s)}getHeightAtCoordinates(i,s){const t=this.getWorldMatrix(),o=e.AA.Matrix[5];t.invertToRef(o);const n=e.AA.Vector3[8];if(e.Pq.TransformCoordinatesFromFloatsToRef(i,0,s,o,n),i=n.x,s=n.z,i<this._minX||i>=this._maxX||s<=this._minZ||s>this._maxZ)return this.position.y;this._heightQuads&&0!=this._heightQuads.length||(this._initHeightQuads(),this._computeHeightQuads());const h=this._getFacetAt(i,s),r=-(h.x*i+h.z*s+h.w)/h.y;return e.Pq.TransformCoordinatesFromFloatsToRef(0,r,0,t,n),n.y}getNormalAtCoordinates(i,s){const t=new e.Pq(0,1,0);return this.getNormalAtCoordinatesToRef(i,s,t),t}getNormalAtCoordinatesToRef(i,s,t){const o=this.getWorldMatrix(),n=e.AA.Matrix[5];o.invertToRef(n);const h=e.AA.Vector3[8];if(e.Pq.TransformCoordinatesFromFloatsToRef(i,0,s,n,h),i=h.x,s=h.z,i<this._minX||i>this._maxX||s<this._minZ||s>this._maxZ)return this;this._heightQuads&&0!=this._heightQuads.length||(this._initHeightQuads(),this._computeHeightQuads());const r=this._getFacetAt(i,s);return e.Pq.TransformNormalFromFloatsToRef(r.x,r.y,r.z,o,t),this}updateCoordinateHeights(){return this._heightQuads&&0!=this._heightQuads.length||this._initHeightQuads(),this._computeHeightQuads(),this}_getFacetAt(i,s){const t=Math.floor((i+this._maxX)*this._subdivisionsX/this._width),e=Math.floor(-(s+this._maxZ)*this._subdivisionsY/this._height+this._subdivisionsY),o=this._heightQuads[e*this._subdivisionsX+t];let n;return n=s<o.slope.x*i+o.slope.y?o.facet1:o.facet2,n}_initHeightQuads(){const i=this._subdivisionsX,s=this._subdivisionsY;this._heightQuads=new Array;for(let t=0;t<s;t++)for(let s=0;s<i;s++){const o={slope:e.I9.Zero(),facet1:new e.IU(0,0,0,0),facet2:new e.IU(0,0,0,0)};this._heightQuads[t*i+s]=o}return this}_computeHeightQuads(){const i=this.getVerticesData(a.R.PositionKind);if(!i)return this;const s=e.AA.Vector3[3],t=e.AA.Vector3[2],o=e.AA.Vector3[1],n=e.AA.Vector3[0],h=e.AA.Vector3[4],r=e.AA.Vector3[5],u=e.AA.Vector3[6],d=e.AA.Vector3[7],c=e.AA.Vector3[8];let l=0,m=0,f=0,p=0,g=0,_=0,b=0;const x=this._subdivisionsX,v=this._subdivisionsY;for(let a=0;a<v;a++)for(let v=0;v<x;v++){l=3*v,m=a*(x+1)*3,f=(a+1)*(x+1)*3,s.x=i[m+l],s.y=i[m+l+1],s.z=i[m+l+2],t.x=i[m+l+3],t.y=i[m+l+4],t.z=i[m+l+5],o.x=i[f+l],o.y=i[f+l+1],o.z=i[f+l+2],n.x=i[f+l+3],n.y=i[f+l+4],n.z=i[f+l+5],p=(n.z-s.z)/(n.x-s.x),g=s.z-p*s.x,t.subtractToRef(s,h),o.subtractToRef(s,r),n.subtractToRef(s,u),e.Pq.CrossToRef(u,r,d),e.Pq.CrossToRef(h,u,c),d.normalize(),c.normalize(),_=-(d.x*s.x+d.y*s.y+d.z*s.z),b=-(c.x*t.x+c.y*t.y+c.z*t.z);const w=this._heightQuads[a*x+v];w.slope.copyFromFloats(p,g),w.facet1.copyFromFloats(d.x,d.y,d.z,_),w.facet2.copyFromFloats(c.x,c.y,c.z,b)}return this}serialize(i){super.serialize(i),i.subdivisionsX=this._subdivisionsX,i.subdivisionsY=this._subdivisionsY,i.minX=this._minX,i.maxX=this._maxX,i.minZ=this._minZ,i.maxZ=this._maxZ,i.width=this._width,i.height=this._height}static Parse(i,s){const t=new u(i.name,s);return t._subdivisionsX=i.subdivisionsX||1,t._subdivisionsY=i.subdivisionsY||1,t._minX=i.minX,t._maxX=i.maxX,t._minZ=i.minZ,t._maxZ=i.maxZ,t._width=i.width,t._height=i.height,t}}var d=t(998),c=t(6315),l=t(5559);function m(i){const s=[],t=[],o=[],n=[];let a,u;const d=i.width||i.size||1,c=i.height||i.size||1,l=0|(i.subdivisionsX||i.subdivisions||1),m=0|(i.subdivisionsY||i.subdivisions||1);for(a=0;a<=m;a++)for(u=0;u<=l;u++){const i=new e.Pq(u*d/l-d/2,0,(m-a)*c/m-c/2),s=new e.Pq(0,1,0);t.push(i.x,i.y,i.z),o.push(s.x,s.y,s.z),n.push(u/l,r.rX?a/m:1-a/m)}for(a=0;a<m;a++)for(u=0;u<l;u++)s.push(u+1+(a+1)*(l+1)),s.push(u+1+a*(l+1)),s.push(u+a*(l+1)),s.push(u+(a+1)*(l+1)),s.push(u+1+(a+1)*(l+1)),s.push(u+a*(l+1));const f=new h.P;return f.indices=s,f.positions=t,f.normals=o,f.uvs=n,f}function f(i){const s=void 0!==i.xmin&&null!==i.xmin?i.xmin:-1,t=void 0!==i.zmin&&null!==i.zmin?i.zmin:-1,o=void 0!==i.xmax&&null!==i.xmax?i.xmax:1,n=void 0!==i.zmax&&null!==i.zmax?i.zmax:1,r=i.subdivisions||{w:1,h:1},a=i.precision||{w:1,h:1},u=[],d=[],c=[],l=[];let m,f,p,g;r.h=r.h<1?1:r.h,r.w=r.w<1?1:r.w,a.w=a.w<1?1:a.w,a.h=a.h<1?1:a.h;const _=(o-s)/r.w,b=(n-t)/r.h;function x(i,s,t,o){const n=d.length/3,h=a.w+1;for(m=0;m<a.h;m++)for(f=0;f<a.w;f++){const i=[n+f+m*h,n+(f+1)+m*h,n+(f+1)+(m+1)*h,n+f+(m+1)*h];u.push(i[1]),u.push(i[2]),u.push(i[3]),u.push(i[0]),u.push(i[1]),u.push(i[3])}const r=e.Pq.Zero(),p=new e.Pq(0,1,0);for(m=0;m<=a.h;m++)for(r.z=m*(o-s)/a.h+s,f=0;f<=a.w;f++)r.x=f*(t-i)/a.w+i,r.y=0,d.push(r.x,r.y,r.z),c.push(p.x,p.y,p.z),l.push(f/a.w,m/a.h)}for(p=0;p<r.h;p++)for(g=0;g<r.w;g++)x(s+g*_,t+p*b,s+(g+1)*_,t+(p+1)*b);const v=new h.P;return v.indices=u,v.positions=d,v.normals=c,v.uvs=l,v}function p(i){const s=[],t=[],n=[],r=[];let a,u;const d=i.colorFilter||new o.v9(.3,.59,.11),c=i.alphaFilter||0;let m=!1;if(i.minHeight>i.maxHeight){m=!0;const s=i.maxHeight;i.maxHeight=i.minHeight,i.minHeight=s}for(a=0;a<=i.subdivisions;a++)for(u=0;u<=i.subdivisions;u++){const s=new e.Pq(u*i.width/i.subdivisions-i.width/2,0,(i.subdivisions-a)*i.height/i.subdivisions-i.height/2),o=4*(((s.x+i.width/2)/i.width*(i.bufferWidth-1)|0)+((1-(s.z+i.height/2)/i.height)*(i.bufferHeight-1)|0)*i.bufferWidth);let h=i.buffer[o]/255,f=i.buffer[o+1]/255,p=i.buffer[o+2]/255;const g=i.buffer[o+3]/255;m&&(h=1-h,f=1-f,p=1-p);const _=h*d.r+f*d.g+p*d.b;s.y=g>=c?i.minHeight+(i.maxHeight-i.minHeight)*_:i.minHeight-l.bH,i.heightBuffer&&(i.heightBuffer[a*(i.subdivisions+1)+u]=s.y),t.push(s.x,s.y,s.z),n.push(0,0,0),r.push(u/i.subdivisions,1-a/i.subdivisions)}for(a=0;a<i.subdivisions;a++)for(u=0;u<i.subdivisions;u++){const e=u+1+(a+1)*(i.subdivisions+1),o=u+1+a*(i.subdivisions+1),n=u+a*(i.subdivisions+1),h=u+(a+1)*(i.subdivisions+1),r=t[3*e+1]>=i.minHeight,d=t[3*o+1]>=i.minHeight,c=t[3*n+1]>=i.minHeight;r&&d&&c&&(s.push(e),s.push(o),s.push(n)),t[3*h+1]>=i.minHeight&&r&&c&&(s.push(h),s.push(e),s.push(n))}h.P.ComputeNormals(t,s,n);const f=new h.P;return f.indices=s,f.positions=t,f.normals=n,f.uvs=r,f}function g(i){let s=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23];const t=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0],n=[];let a=[];const u=i.width||i.size||1,d=i.height||i.size||1,c=i.depth||i.size||1,l=i.wrap||!1;let m=void 0===i.topBaseAt?1:i.topBaseAt,f=void 0===i.bottomBaseAt?0:i.bottomBaseAt;m=(m+4)%4,f=(f+4)%4;let p=[2,0,3,1][m],g=[2,0,1,3][f],_=[1,-1,1,-1,-1,1,-1,1,1,1,1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,-1,-1,-1,1];if(l){s=[2,3,0,2,0,1,4,5,6,4,6,7,9,10,11,9,11,8,12,14,15,12,13,14],_=[-1,1,1,1,1,1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,1,1,1,-1,1,-1,-1,1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1];let i=[[1,1,1],[-1,1,1],[-1,1,-1],[1,1,-1]],t=[[-1,-1,1],[1,-1,1],[1,-1,-1],[-1,-1,-1]];const e=[17,18,19,16],o=[22,23,20,21];for(;p>0;)i.unshift(i.pop()),e.unshift(e.pop()),p--;for(;g>0;)t.unshift(t.pop()),o.unshift(o.pop()),g--;i=i.flat(),t=t.flat(),_=_.concat(i).concat(t),s.push(e[0],e[2],e[3],e[0],e[1],e[2]),s.push(o[0],o[2],o[3],o[0],o[1],o[2])}const b=[u/2,d/2,c/2];a=_.reduce(((i,s,t)=>i.concat(s*b[t%3])),[]);const x=0===i.sideOrientation?0:i.sideOrientation||h.P.DEFAULTSIDE,v=i.faceUV||new Array(6),w=i.faceColors,y=[];for(let i=0;i<6;i++)void 0===v[i]&&(v[i]=new e.IU(0,0,1,1)),w&&void 0===w[i]&&(w[i]=new o.ov(1,1,1,1));for(let i=0;i<6;i++)if(n.push(v[i].z,r.rX?1-v[i].w:v[i].w),n.push(v[i].x,r.rX?1-v[i].w:v[i].w),n.push(v[i].x,r.rX?1-v[i].y:v[i].y),n.push(v[i].z,r.rX?1-v[i].y:v[i].y),w)for(let s=0;s<4;s++)y.push(w[i].r,w[i].g,w[i].b,w[i].a);h.P._ComputeSides(x,a,s,t,n,i.frontUVs,i.backUVs);const z=new h.P;if(z.indices=s,z.positions=a,z.normals=t,z.uvs=n,w){const i=x===h.P.DOUBLESIDE?y.concat(y):y;z.colors=i}return z}function _(i,s={},t=null){const e=new n.e(i,t);return s.sideOrientation=n.e._GetDefaultSideOrientation(s.sideOrientation),e._originalBuilderSideOrientation=s.sideOrientation,g(s).applyToMesh(e,s.updatable),e}h.P.CreateGround=m,h.P.CreateTiledGround=f,h.P.CreateGroundFromHeightMap=p,n.e.CreateGround=(i,s,t,e,o,n)=>function(i,s={},t){const e=new u(i,t);return e._setReady(!1),e._subdivisionsX=s.subdivisionsX||s.subdivisions||1,e._subdivisionsY=s.subdivisionsY||s.subdivisions||1,e._width=s.width||1,e._height=s.height||1,e._maxX=e._width/2,e._maxZ=e._height/2,e._minX=-e._maxX,e._minZ=-e._maxZ,m(s).applyToMesh(e,s.updatable),e._setReady(!0),e}(i,{width:s,height:t,subdivisions:e,updatable:n},o),n.e.CreateTiledGround=(i,s,t,e,o,h,r,a,u)=>function(i,s,t=null){const e=new n.e(i,t);return f(s).applyToMesh(e,s.updatable),e}(i,{xmin:s,zmin:t,xmax:e,zmax:o,subdivisions:h,precision:r,updatable:u},a),n.e.CreateGroundFromHeightMap=(i,s,t,e,n,h,r,a,l,m,f)=>function(i,s,t={},e=null){const n=t.width||10,h=t.height||10,r=t.subdivisions||1,a=t.minHeight||0,l=t.maxHeight||1,m=t.colorFilter||new o.v9(.3,.59,.11),f=t.alphaFilter||0,g=t.updatable,_=t.onReady;e=e||c.q.LastCreatedScene;const b=new u(i,e);let x;b._subdivisionsX=r,b._subdivisionsY=r,b._width=n,b._height=h,b._maxX=b._width/2,b._maxZ=b._height/2,b._minX=-b._maxX,b._minZ=-b._maxZ,b._setReady(!1),t.passHeightBufferInCallback&&(x=new Float32Array((r+1)*(r+1)));const v=(i,s,t)=>{p({width:n,height:h,subdivisions:r,minHeight:a,maxHeight:l,colorFilter:m,buffer:i,bufferWidth:s,bufferHeight:t,alphaFilter:f,heightBuffer:x}).applyToMesh(b,g),_&&_(b,x),b._setReady(!0)};if("string"==typeof s){const i=i=>{const s=i.width,t=i.height;if(e.isDisposed)return;const o=e?.getEngine().resizeImageBitmap(i,s,t);v(o,s,t)};d.S0.LoadImage(s,i,t.onError?t.onError:()=>{},e.offlineProvider)}else v(s.data,s.width,s.height);return b}(i,s,{width:t,height:e,subdivisions:n,minHeight:h,maxHeight:r,updatable:l,onReady:m,alphaFilter:f},a),h.P.CreateBox=g,n.e.CreateBox=(i,s,t=null,e,o)=>_(i,{size:s,sideOrientation:o,updatable:e},t)}}]);