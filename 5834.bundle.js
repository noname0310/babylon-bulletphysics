"use strict";(self.webpackChunkbabylon_bulletphysics=self.webpackChunkbabylon_bulletphysics||[]).push([[5834,9928],{5834:(e,t,r)=>{r.r(t),r.d(t,{_ENVTextureLoader:()=>x});var n=r(998),a=r(9923),o=r(4867),i=r(4640),s=r(854),l=r(2667),u=(r(554),r(7891)),p=r(1137);r(8864),r(9928);var c=r(6755);l.t.prototype.forceSphericalPolynomialsRecompute=function(){this._texture&&(this._texture._sphericalPolynomial=null,this._texture._sphericalPolynomialPromise=null,this._texture._sphericalPolynomialComputed=!1)},Object.defineProperty(l.t.prototype,"sphericalPolynomial",{get:function(){if(this._texture){if(this._texture._sphericalPolynomial||this._texture._sphericalPolynomialComputed)return this._texture._sphericalPolynomial;if(this._texture.isReady)return this._texture._sphericalPolynomialPromise||(this._texture._sphericalPolynomialPromise=c.d.ConvertCubeMapTextureToSphericalPolynomial(this),null===this._texture._sphericalPolynomialPromise?this._texture._sphericalPolynomialComputed=!0:this._texture._sphericalPolynomialPromise.then((e=>{this._texture._sphericalPolynomial=e,this._texture._sphericalPolynomialComputed=!0}))),null}return null},set:function(e){this._texture&&(this._texture._sphericalPolynomial=e)},enumerable:!0,configurable:!0});const d="image/png",f=[134,22,135,150,246,214,150,54];function h(e){if(e.version>2)throw new Error(`Unsupported babylon environment map version "${e.version}". Latest supported version is "2".`);return 2===e.version?e:e={...e,version:2,imageType:d}}function m(e,t,r){const n=(r=h(r)).specular;if(!n)return Promise.resolve([]);e._lodGenerationScale=n.lodGenerationScale;const a=[],o=function(e,t){const r=(t=h(t)).specular;let n=Math.log2(t.width);if(n=Math.round(n)+1,r.mipmaps.length!==6*n)throw new Error(`Unsupported specular mipmaps number "${r.mipmaps.length}"`);const a=new Array(n);for(let o=0;o<n;o++){a[o]=new Array(6);for(let n=0;n<6;n++){const i=r.mipmaps[6*o+n];a[o][n]=new Uint8Array(e.buffer,e.byteOffset+t.binaryDataPosition+i.position,i.length)}}return a}(t,r);a.push(async function(e,t,r=d){const n=e.getEngine();e.format=5,e.type=0,e.generateMipMaps=!0,e._cachedAnisotropicFilteringLevel=null,n.updateTextureSamplingMode(3,e),await g(e,t,!0,r),e.isReady=!0}(e,o,r.imageType));const i=r.irradiance?.irradianceTexture;if(i){const n=function(e,t){t=h(t);const r=new Array(6),n=t.irradiance?.irradianceTexture;if(n){if(6!==n.faces.length)throw new Error(`Incorrect irradiance texture faces number "${n.faces.length}"`);for(let a=0;a<6;a++){const o=n.faces[a];r[a]=new Uint8Array(e.buffer,e.byteOffset+t.binaryDataPosition+o.position,o.length)}}return r}(t,r);a.push(async function(e,t,r,n=d){const a=e.getEngine(),o=new s.h(a,5),i=new l.t(a,o);e._irradianceTexture=i,o.isCube=!0,o.format=5,o.type=0,o.generateMipMaps=!0,o._cachedAnisotropicFilteringLevel=null,o.generateMipMaps=!0,o.width=r,o.height=r,a.updateTextureSamplingMode(3,o),await g(o,[t],!1,n),a.generateMipMapsForCubemap(o),o.isReady=!0}(e,n,i.size,r.imageType))}return Promise.all(a)}function y(e,t,r,n,a,o,i,s,l,u,p){return new Promise(((c,d)=>{if(r){const r=t.createTexture(null,!0,!0,null,1,null,(e=>{d(e)}),e);n?.onEffectCreatedObservable.addOnce((s=>{s.executeWhenCompiled((()=>{n.externalTextureSamplerBinding=!0,n.onApply=n=>{n._bindTexture("textureSampler",r),n.setFloat2("scale",1,t._features.needsInvertingBitmap&&e instanceof ImageBitmap?-1:1)},t.scenes.length&&(t.scenes[0].postProcessManager.directRender([n],u,!0,o,i),t.restoreDefaultFramebuffer(),r.dispose(),URL.revokeObjectURL(a),c())}))}))}else{if(t._uploadImageToTexture(p,e,o,i),s){const r=l[i];r&&t._uploadImageToTexture(r._texture,e,o,0)}c()}}))}async function g(e,t,a,i=d){if(!n.S0.IsExponentOfTwo(e.width))throw new Error("Texture size must be a power of two");const p=(0,o.C0)(e.width)+1,c=e.getEngine();let f=!1,h=!1,m=null,g=null,x=null;const w=c.getCaps();w.textureLOD?c._features.supportRenderAndCopyToLodForFloatTextures?w.textureHalfFloatRender&&w.textureHalfFloatLinearFiltering?(f=!0,e.type=2):w.textureFloatRender&&w.textureFloatLinearFiltering&&(f=!0,e.type=1):f=!1:(f=!1,h=a);let _=0;if(f)c.isWebGPU?(_=1,await r.e(3126).then(r.bind(r,371))):await r.e(9071).then(r.bind(r,9682)),m=new u.w("rgbdDecode","rgbdDecode",null,null,1,null,3,c,!1,void 0,e.type,void 0,null,!1,void 0,_),e._isRGBD=!1,e.invertY=!1,g=c.createRenderTargetCubeTexture(e.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:e.type,format:5});else if(e._isRGBD=!0,e.invertY=!0,h){const t=3;x={};const r=e._lodGenerationScale,n=e._lodGenerationOffset;for(let a=0;a<t;a++){const o=(p-1)*r+n,i=n+(o-n)*(1-a/(t-1)),u=Math.round(Math.min(Math.max(i,0),o)),d=new s.h(c,2);d.isCube=!0,d.invertY=!0,d.generateMipMaps=!1,c.updateTextureSamplingMode(2,d);const f=new l.t(null);switch(f._isCube=!0,f._texture=d,x[u]=f,a){case 0:e._lodTextureLow=f;break;case 1:e._lodTextureMid=f;break;case 2:e._lodTextureHigh=f}}}const b=[];for(let r=0;r<t.length;r++)for(let n=0;n<6;n++){const a=t[r][n],o=new Blob([a],{type:i}),s=URL.createObjectURL(o);let l;if(c._features.forceBitmapOverHTMLImageElement)l=c.createImageBitmap(o,{premultiplyAlpha:"none"}).then((t=>y(t,c,f,m,s,n,r,h,x,g,e)));else{const t=new Image;t.src=s,l=new Promise(((a,o)=>{t.onload=()=>{y(t,c,f,m,s,n,r,h,x,g,e).then((()=>a())).catch((e=>{o(e)}))},t.onerror=e=>{o(e)}}))}b.push(l)}if(await Promise.all(b),t.length<p){let r;const n=Math.pow(2,p-1-t.length),a=n*n*4;switch(e.type){case 0:r=new Uint8Array(a);break;case 2:r=new Uint16Array(a);break;case 1:r=new Float32Array(a)}for(let n=t.length;n<p;n++)for(let t=0;t<6;t++)c._uploadArrayBufferViewToTexture(g?.texture||e,r,t,n)}if(g){const t=e._irradianceTexture;e._irradianceTexture=null,c._releaseTexture(e),g._swapAndDie(e),e._irradianceTexture=t}m&&m.dispose(),h&&(e._lodTextureHigh&&e._lodTextureHigh._texture&&(e._lodTextureHigh._texture.isReady=!0),e._lodTextureMid&&e._lodTextureMid._texture&&(e._lodTextureMid._texture.isReady=!0),e._lodTextureLow&&e._lodTextureLow._texture&&(e._lodTextureLow._texture.isReady=!0))}class x{constructor(){this.supportCascades=!1}loadCubeData(e,t,r,n,o){if(Array.isArray(e))return;const s=function(e){const t=new DataView(e.buffer,e.byteOffset,e.byteLength);let r=0;for(let e=0;e<f.length;e++)if(t.getUint8(r++)!==f[e])return p.V.Error("Not a babylon environment map"),null;let n="",a=0;for(;a=t.getUint8(r++);)n+=String.fromCharCode(a);let o=JSON.parse(n);return o=h(o),o.binaryDataPosition=r,o.specular&&(o.specular.lodGenerationScale=o.specular.lodGenerationScale||.8),o}(e);if(s){t.width=s.width,t.height=s.width;try{(function(e,t){const r=(t=h(t)).irradiance;if(!r)return;const n=new i.Q;a.Pq.FromArrayToRef(r.x,0,n.x),a.Pq.FromArrayToRef(r.y,0,n.y),a.Pq.FromArrayToRef(r.z,0,n.z),a.Pq.FromArrayToRef(r.xx,0,n.xx),a.Pq.FromArrayToRef(r.yy,0,n.yy),a.Pq.FromArrayToRef(r.zz,0,n.zz),a.Pq.FromArrayToRef(r.yz,0,n.yz),a.Pq.FromArrayToRef(r.zx,0,n.zx),a.Pq.FromArrayToRef(r.xy,0,n.xy),e._sphericalPolynomial=n})(t,s),m(t,e,s).then((()=>{t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),n&&n()}),(e=>{o?.("Can not upload environment levels",e)}))}catch(e){o?.("Can not upload environment file",e)}}else o&&o("Can not parse the environment file",null)}loadData(){throw".env not supported in 2d."}}},9928:(e,t,r)=>{r.r(t),r.d(t,{Dispose:()=>d,DumpData:()=>c,DumpDataAsync:()=>p,DumpFramebuffer:()=>u,DumpTools:()=>f});var n=r(4255),a=r(998),o=r(4867),i=r(6315);let s,l=null;async function u(e,t,r,n,a="image/png",o,i){const s=await r.readPixels(0,0,e,t);c(e,t,new Uint8Array(s.buffer),n,a,o,!0,void 0,i)}function p(e,t,r,n="image/png",a,o=!1,i=!1,s){return new Promise((l=>{c(e,t,r,(e=>l(e)),n,a,o,i,s)}))}function c(e,t,u,p,c="image/png",f,h=!1,m=!1,y){(async function(){return l||(l=new Promise(((e,t)=>{let a,o=null;const l={preserveDrawingBuffer:!0,depth:!1,stencil:!1,alpha:!0,premultipliedAlpha:!1,antialias:!1,failIfMajorPerformanceCaveat:!1};Promise.resolve().then(r.bind(r,6321)).then((({ThinEngine:u})=>{const p=i.q.Instances.length;try{a=new OffscreenCanvas(100,100),o=new u(a,!1,l)}catch(e){p<i.q.Instances.length&&i.q.Instances.pop()?.dispose(),a=document.createElement("canvas"),o=new u(a,!1,l)}i.q.Instances.pop(),i.q.OnEnginesDisposedObservable.add((e=>{o&&e!==o&&!o.isDisposed&&0===i.q.Instances.length&&d()})),o.getCaps().parallelShaderCompile=void 0;const c=new n.J(o);r.e(9071).then(r.bind(r,9820)).then((({passPixelShader:r})=>{if(!o)return void t("Engine is not defined");const i=new n.$({engine:o,name:r.name,fragmentShader:r.shader,samplerNames:["textureSampler"]});s={canvas:a,engine:o,renderer:c,wrapper:i},e(s)}))})).catch(t)}))),await l})().then((r=>{if(r.engine.setSize(e,t,!0),u instanceof Float32Array){const e=new Uint8Array(u.length);let t=u.length;for(;t--;){const r=u[t];e[t]=Math.round(255*(0,o.OQ)(r))}u=e}const n=r.engine.createRawTexture(u,e,t,5,!1,!h,1);r.renderer.setViewport(),r.renderer.applyEffectWrapper(r.wrapper),r.wrapper.effect._bindTexture("textureSampler",n),r.renderer.draw(),m?a.S0.ToBlob(r.canvas,(e=>{const t=new FileReader;t.onload=e=>{const t=e.target.result;p&&p(t)},t.readAsArrayBuffer(e)}),c,y):a.S0.EncodeScreenshotCanvasData(r.canvas,p,c,f,y),n.dispose()}))}function d(){s?(s.wrapper.dispose(),s.renderer.dispose(),s.engine.dispose()):l?.then((e=>{e.wrapper.dispose(),e.renderer.dispose(),e.engine.dispose()})),l=null,s=null}const f={DumpData:c,DumpDataAsync:p,DumpFramebuffer:u,Dispose:d};a.S0.DumpData=c,a.S0.DumpDataAsync=p,a.S0.DumpFramebuffer=u}}]);