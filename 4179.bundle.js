"use strict";(self.webpackChunkbabylon_bulletphysics=self.webpackChunkbabylon_bulletphysics||[]).push([[4179],{2399:(e,t,n)=>{n.d(t,{q:()=>o});class o{_a;constructor(e){this._a=e}next(){let e=this._a+=1831565813;return e=Math.imul(e^e>>>15,1|e),e^=e+Math.imul(e^e>>>7,61|e),((e^e>>>14)>>>0)/4294967296}}},4179:(e,t,n)=>{n.r(t),n.d(t,{SceneBuilder:()=>S}),n(203),n(1503),n(8227);var o=n(7456),a=n(5581),s=n(1513),r=n(9711),i=n(6041),c=n(9923),l=n(9899),u=n(8144),d=n(8121),p=n(554),h=n(6738),w=n(7168),m=n(2090),f=n(7744),g=n(1167),T=n(5733),P=n(6405),b=n(1592),y=n(5901),q=n(9800),x=n(2399);class S{async build(e,t){const n=new p.Z(t);n.clearColor=new i.ov(.95,.95,.95,1);const S=new o.Lq("arcRotateCamera",0,0,500,new c.Pq(0,0,0),n);S.minZ=1,S.maxZ=3e3,S.setPosition(new c.Pq(60,40,-50).scaleInPlace(10)),S.attachControl(void 0,!1),S.inertia=.8,S.speed=10;const R=new s.g("hemisphericLight",new c.Pq(0,1,0),n);R.intensity=.5,R.specular=new i.v9(0,0,0),R.groundColor=new i.v9(1,1,1);const I=new a.Z("directionalLight",new c.Pq(.5,-1,1),n);I.intensity=.5;I.shadowMaxZ=250,I.shadowMinZ=-250,I.autoCalcShadowZBounds=!1,I.autoUpdateExtends=!1,I.shadowOrthoScale=0,I.orthoTop=250,I.orthoBottom=-250,I.orthoLeft=-250,I.orthoRight=250;const C=new r.o(2048,I,!0);C.transparencyShadow=!0,C.usePercentageCloserFiltering=!0,C.forceBackFacesOnly=!1,C.bias=.004,C.filteringQuality=r.o.QUALITY_MEDIUM;const M=parseInt(prompt("Thread count","2"));console.log("Thread count:",M);const v=1===M?await(0,h.e)(new g.Z):await(0,h.e)(new f.t,M),L=new m.D(v),O=new T.F(L,!0),B=new c.uq;{const e=(0,u.x)("ground",{size:500},n);e.rotationQuaternion=c.PT.RotationAxis(new c.Pq(1,0,0),Math.PI/2),C.addShadowCaster(e),e.receiveShadows=!0;const t=new P.Ty(L,new c.Pq(0,0,-1),0),o=new y.t(v);o.shape=t,c.uq.FromQuaternionToRef(e.rotationQuaternion,B),o.setInitialTransform(B),o.motionType=1;const a=new b.U(L,o);O.addRigidBodyToGlobal(a)}const U=512,Z=[],_=[];if("u"===prompt("Shape type (u, r) uniform box, random","u")){const e=new c.Pq(1,1,1),t=new P.SA(L,e),n={type:"box",size:e};for(let e=0;e<U;++e)Z.push(t),_.push(n)}else{const e=new x.q(0);for(let t=0;t<U;++t){const t=2*e.next()|0;if(0===t){const t=2*e.next()+.5,n=2*e.next()+.5,o=2*e.next()+.5,a=new c.Pq(t,n,o);Z.push(new P.SA(L,a)),_.push({type:"box",size:a})}else{if(1!==t)throw new Error("Invalid type");{const t=2*e.next()+1;Z.push(new P.O4(L,t)),_.push({type:"sphere",radius:t})}}}}const z=[];for(let e=0;e<4;++e)for(let t=0;t<8;++t){const n=8*e+t,o=60*(t-4)+30,a=60*(e-2)+30,s=[];for(let e=0;e<U;++e){const t=new y.t(v);t.shape=Z[e];const n=c.uq.TranslationToRef(o,1+2*e,a,B);t.setInitialTransform(n),t.friction=1,t.linearDamping=.3,t.angularDamping=.3,s.push(t)}for(let e=0;e<U;++e){const t=s[e],o=new b.U(L,t);O.addRigidBody(o,n),z.push(o)}for(let e=0;e<U;e+=2){const t=[n*U+e,n*U+e+1],o=new w.vC(L,z[t[0]],z[t[1]],c.uq.Translation(0,-1.2,0),c.uq.Translation(0,1.2,0),!0);o.setLinearLowerLimit(new c.Pq(0,0,0)),o.setLinearUpperLimit(new c.Pq(0,0,0)),o.setAngularLowerLimit(new c.Pq(Math.PI/4,0,0)),o.setAngularUpperLimit(new c.Pq(0,0,0));for(let e=0;e<6;++e)o.enableSpring(e,!0),o.setStiffness(e,100),o.setDamping(e,1);O.addConstraint(o,n,!0)}}console.log("Rigid body count:",16384);const D=[],F=(0,l.an)("baseBox",{size:1},n),Q=(0,d._6)("baseSphere",{diameter:1},n);F.setEnabled(!1),Q.setEnabled(!1),F.receiveShadows=!0,Q.receiveShadows=!0;for(let e=0;e<16384;++e){const t=_[e%_.length],n="box"===t.type?F.createInstance(`boxInstance${e}`):Q.createInstance(`sphereInstance${e}`);C.addShadowCaster(n),n.scaling.copyFrom("box"===t.type?t.size.scale(2):new c.Pq(t.radius,t.radius,t.radius).scale(2)),n.rotationQuaternion=c.PT.Identity(),D.push(n)}return new q.X((()=>{const e=performance.now();O.stepSimulation(1/60,10,1/60);for(let e=0;e<z.length;++e){z[e].getTransformMatrixToRef(B);const t=D[e];B.getTranslationToRef(t.position),c.PT.FromRotationMatrixToRef(B,t.rotationQuaternion)}const t=performance.now(),o=t-e;return n.render(),[o,performance.now()-t]})).runBench(),n.onBeforeRenderObservable.add((()=>{O.stepSimulation(1/60,10,1/60);for(let e=0;e<z.length;++e){z[e].getTransformMatrixToRef(B);const t=D[e];B.getTranslationToRef(t.position),c.PT.FromRotationMatrixToRef(B,t.rotationQuaternion)}})),n}}},8121:(e,t,n)=>{n.d(t,{_6:()=>c});var o=n(9923),a=n(1812),s=n(6803),r=n(1313);function i(e){const t=0|(e.segments||32),n=e.diameterX||e.diameter||1,a=e.diameterY||e.diameter||1,i=e.diameterZ||e.diameter||1,c=e.arc&&(e.arc<=0||e.arc>1)?1:e.arc||1,l=e.slice&&e.slice<=0?1:e.slice||1,u=0===e.sideOrientation?0:e.sideOrientation||s.P.DEFAULTSIDE,d=!!e.dedupTopBottomIndices,p=new o.Pq(n/2,a/2,i/2),h=2+t,w=2*h,m=[],f=[],g=[],T=[];for(let e=0;e<=h;e++){const t=e/h,n=t*Math.PI*l;for(let e=0;e<=w;e++){const a=e/w,s=a*Math.PI*2*c,i=o.uq.RotationZ(-n),l=o.uq.RotationY(s),u=o.Pq.TransformCoordinates(o.Pq.Up(),i),d=o.Pq.TransformCoordinates(u,l),h=d.multiply(p),m=d.divide(p).normalize();f.push(h.x,h.y,h.z),g.push(m.x,m.y,m.z),T.push(a,r.rX?1-t:t)}if(e>0){const t=f.length/3;for(let n=t-2*(w+1);n+w+2<t;n++)d?(e>1&&(m.push(n),m.push(n+1),m.push(n+w+1)),(e<h||l<1)&&(m.push(n+w+1),m.push(n+1),m.push(n+w+2))):(m.push(n),m.push(n+1),m.push(n+w+1),m.push(n+w+1),m.push(n+1),m.push(n+w+2))}}s.P._ComputeSides(u,f,m,g,T,e.frontUVs,e.backUVs);const P=new s.P;return P.indices=m,P.positions=f,P.normals=g,P.uvs=T,P}function c(e,t={},n=null){const o=new a.e(e,n);return t.sideOrientation=a.e._GetDefaultSideOrientation(t.sideOrientation),o._originalBuilderSideOrientation=t.sideOrientation,i(t).applyToMesh(o,t.updatable),o}s.P.CreateSphere=i,a.e.CreateSphere=(e,t,n,o,a,s)=>c(e,{segments:t,diameterX:n,diameterY:n,diameterZ:n,sideOrientation:s,updatable:a},o)}}]);