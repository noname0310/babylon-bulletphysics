"use strict";(self.webpackChunkbabylon_bulletphysics=self.webpackChunkbabylon_bulletphysics||[]).push([[2541],{32541:(e,t,n)=>{n.r(t),n.d(t,{SceneBuilder:()=>g}),n(90203),n(61440),n(33832),n(2093);var o=n(7839),s=n(52046),r=n(71513),a=n(18595),i=n(26041),l=n(79923),c=n(96793),d=n(58144),u=n(78121),h=n(87491),w=n(67774),p=n(89800),b=n(32399);class g{async build(e,t){const n=new h.Z(t);n.clearColor=new i.ov(.95,.95,.95,1);const g=new o.L("arcRotateCamera",0,0,500,new l.Pq(0,0,0),n);g.minZ=1,g.maxZ=3e3,g.setPosition(new l.Pq(60,40,-50).scaleInPlace(10)),g.attachControl(void 0,!1),g.inertia=.8,g.speed=10;const f=new r.g("hemisphericLight",new l.Pq(0,1,0),n);f.intensity=.5,f.specular=new i.v9(0,0,0),f.groundColor=new i.v9(1,1,1);const y=new s.Z("directionalLight",new l.Pq(.5,-1,1),n);y.intensity=.5;y.shadowMaxZ=250,y.shadowMinZ=-250,y.autoCalcShadowZBounds=!1,y.autoUpdateExtends=!1,y.shadowOrthoScale=0,y.orthoTop=250,y.orthoBottom=-250,y.orthoLeft=-250,y.orthoRight=250;const m=new a.o(2048,y,!0);m.transparencyShadow=!0,m.usePercentageCloserFiltering=!0,m.forceBackFacesOnly=!1,m.bias=.004,m.filteringQuality=a.o.QUALITY_MEDIUM;const S=await(0,w.A)(),x=[];for(let e=0;e<32;++e){const e=new S.btDefaultCollisionConfiguration,t=new S.btCollisionDispatcher(e),n=new S.btDbvtBroadphase,o=new S.btSequentialImpulseConstraintSolver,s=new S.btDiscreteDynamicsWorld(t,n,o,e);s.setGravity(new S.btVector3(0,-10,0)),x.push(s)}const T=new l.uq;{const e=(0,d.x)("ground",{size:500},n);e.rotationQuaternion=l.PT.RotationAxis(new l.Pq(1,0,0),Math.PI/2),m.addShadowCaster(e),e.receiveShadows=!0;const t=new S.btVector3(0,0,-1),o=new S.btStaticPlaneShape(t,0);S.destroy(t);const s=new S.btDefaultMotionState,r=new S.btRigidBodyConstructionInfo(0,s,o);l.uq.FromQuaternionToRef(e.rotationQuaternion,T);const a=new S.btTransform;a.setFromOpenGLMatrix(T.asArray()),s.setWorldTransform(a),S.destroy(a);for(let e=0;e<x.length;++e){const t=new S.btRigidBody(r);t.setDamping(0,0),t.setFriction(.5),t.setRestitution(0),t.setSleepingThresholds(0,1),t.setCollisionFlags(2|t.getCollisionFlags()),x[e].addRigidBody(t)}S.destroy(r)}const C=512,L=[],_=[];if("u"===prompt("Shape type (u, r) uniform box, random","u")){const e=new l.Pq(1,1,1),t=new S.btVector3(e.x,e.y,e.z),n=new S.btBoxShape(t);S.destroy(t);const o={type:"box",size:e};for(let e=0;e<C;++e)L.push(n),_.push(o)}else{const e=new b.q(0);for(let t=0;t<C;++t){const t=2*e.next()|0;if(0===t){const t=2*e.next()+.5,n=2*e.next()+.5,o=2*e.next()+.5,s=new l.Pq(t,n,o),r=new S.btVector3(s.x,s.y,s.z);L.push(new S.btBoxShape(r)),S.destroy(r),_.push({type:"box",size:s})}else{if(1!==t)throw new Error("Invalid type");{const t=2*e.next()+1;L.push(new S.btSphereShape(t)),_.push({type:"sphere",radius:t})}}}}const q=[];for(let e=0;e<4;++e)for(let t=0;t<8;++t){const n=8*e+t,o=60*(t-4)+30,s=60*(e-2)+30,r=[];for(let e=0;e<C;++e){const t=l.uq.TranslationToRef(o,1+2*e,s,T),n=new S.btDefaultMotionState,a=new S.btTransform;a.setFromOpenGLMatrix(t.asArray()),n.setWorldTransform(a),S.destroy(a);const i=new S.btVector3(0,0,0);L[e].calculateLocalInertia(1,i);const c=new S.btRigidBodyConstructionInfo(1,n,L[e],i);S.destroy(i),c.set_m_friction(1),c.set_m_linearDamping(.3),c.set_m_angularDamping(.3),c.set_m_linearSleepingThreshold(0),c.set_m_angularSleepingThreshold(1),r.push(c)}const a=x[n];for(let e=0;e<C;++e){const t=r[e],n=new S.btRigidBody(t);a.addRigidBody(n),q.push(n)}for(let e=0;e<r.length;++e)S.destroy(r[e]);for(let e=0;e<C;e+=2){const t=[n*C+e,n*C+e+1],o=new S.btTransform,s=new S.btTransform;o.setFromOpenGLMatrix(l.uq.Translation(0,-1.2,0).asArray()),s.setFromOpenGLMatrix(l.uq.Translation(0,1.2,0).asArray());const r=new S.btGeneric6DofSpringConstraint(q[t[0]],q[t[1]],o,s,!0);S.destroy(o),S.destroy(s);const i=new S.btVector3(0,0,0);i.setValue(0,0,0),r.setLinearLowerLimit(i),i.setValue(0,0,0),r.setLinearUpperLimit(i),i.setValue(Math.PI/4,0,0),r.setAngularLowerLimit(i),i.setValue(0,0,0),r.setAngularUpperLimit(i),S.destroy(i);for(let e=0;e<6;++e)r.enableSpring(e,!0),r.setStiffness(e,100),r.setDamping(e,1);a.addConstraint(r,!0)}}console.log("Rigid body count:",16384);const B=[],M=(0,c.an)("baseBox",{size:1},n),P=(0,u._6)("baseSphere",{diameter:1},n);M.setEnabled(!1),P.setEnabled(!1),M.receiveShadows=!0,P.receiveShadows=!0;for(let e=0;e<16384;++e){const t=_[e%_.length],n="box"===t.type?M.createInstance(`boxInstance${e}`):P.createInstance(`sphereInstance${e}`);m.addShadowCaster(n),n.scaling.copyFrom("box"===t.type?t.size.scale(2):new l.Pq(t.radius,t.radius,t.radius).scale(2)),n.rotationQuaternion=l.PT.Identity(),B.push(n)}const R=new S.btTransform;return new p.X((()=>{const e=performance.now();for(let e=0;e<x.length;++e)x[e].stepSimulation(1/60,10,1/60);for(let e=0;e<q.length;++e){q[e].getMotionState().getWorldTransform(R);const t=R.getOrigin(),n=R.getRotation(),o=B[e];o.position.set(t.x(),t.y(),t.z()),o.rotationQuaternion.set(n.x(),n.y(),n.z(),n.w())}const t=performance.now(),o=t-e;return n.render(),[o,performance.now()-t]})).runBench(),n.onBeforeRenderObservable.add((()=>{for(let e=0;e<x.length;++e)x[e].stepSimulation(1/60,10,1/60);for(let e=0;e<q.length;++e){q[e].getMotionState().getWorldTransform(R);const t=R.getOrigin(),n=R.getRotation(),o=B[e];o.position.set(t.x(),t.y(),t.z()),o.rotationQuaternion.set(n.x(),n.y(),n.z(),n.w())}})),n}}},32399:(e,t,n)=>{n.d(t,{q:()=>o});class o{_a;constructor(e){this._a=e}next(){let e=this._a+=1831565813;return e=Math.imul(e^e>>>15,1|e),e^=e+Math.imul(e^e>>>7,61|e),((e^e>>>14)>>>0)/4294967296}}}}]);