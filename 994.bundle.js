"use strict";(self.webpackChunkbabylon_bulletphysics=self.webpackChunkbabylon_bulletphysics||[]).push([[994,5249],{994:(e,t,r)=>{r.r(t),r.d(t,{_DDSTextureLoader:()=>n});var a=r(4640),o=r(5249);class n{constructor(){this.supportCascades=!0}loadCubeData(e,t,r,n){const s=t.getEngine();let l,i=!1,f=1e3;if(Array.isArray(e))for(let r=0;r<e.length;r++){const a=e[r];l=o.DDSTools.GetDDSInfo(a),t.width=l.width,t.height=l.height,i=(l.isRGB||l.isLuminance||l.mipmapCount>1)&&t.generateMipMaps,s._unpackFlipY(l.isCompressed),o.DDSTools.UploadDDSLevels(s,t,a,l,i,6,-1,r),l.isFourCC||1!==l.mipmapCount?f=l.mipmapCount-1:s.generateMipMapsForCubemap(t)}else{const n=e;l=o.DDSTools.GetDDSInfo(n),t.width=l.width,t.height=l.height,r&&(l.sphericalPolynomial=new a.Q),i=(l.isRGB||l.isLuminance||l.mipmapCount>1)&&t.generateMipMaps,s._unpackFlipY(l.isCompressed),o.DDSTools.UploadDDSLevels(s,t,n,l,i,6),l.isFourCC||1!==l.mipmapCount?f=l.mipmapCount-1:s.generateMipMapsForCubemap(t,!1)}s._setCubeMapTextureParams(t,i,f),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),n&&n({isDDS:!0,width:t.width,info:l,data:e,texture:t})}loadData(e,t,r){const a=o.DDSTools.GetDDSInfo(e),n=(a.isRGB||a.isLuminance||a.mipmapCount>1)&&t.generateMipMaps&&Math.max(a.width,a.height)>>a.mipmapCount-1==1;r(a.width,a.height,n,a.isFourCC,(()=>{o.DDSTools.UploadDDSLevels(t.getEngine(),t,e,a,n,1)}))}}},5249:(e,t,r)=>{r.d(t,{DDSTools:()=>m});var a=r(4867),o=r(1137),n=r(6755),s=r(8864),l=r(854),i=r(655),f=r(8688),u=r(6326),c=r(8454);u.$.prototype._partialLoadFile=function(e,t,r,a,o=null){this._loadFile(e,(e=>{r[t]=e,r._internalCount++,6===r._internalCount&&a(r)}),void 0,void 0,!0,((e,t)=>{o&&e&&o(e.status+" "+e.statusText,t)}))},u.$.prototype._cascadeLoadFiles=function(e,t,r,a=null){const o=[];o._internalCount=0;for(let e=0;e<6;e++)this._partialLoadFile(r[e],e,o,t,a)},u.$.prototype._cascadeLoadImgs=function(e,t,r,a,o=null,n){const s=[];s._internalCount=0;for(let l=0;l<6;l++)this._partialLoadImg(a[l],l,s,e,t,r,o,n)},u.$.prototype._partialLoadImg=function(e,t,r,a,o,n,s=null,l){const u=(0,f.z)();(0,i.W$)(e,(e=>{r[t]=e,r._internalCount++,a&&a.removePendingData(u),6===r._internalCount&&n&&n(o,r)}),((e,t)=>{a&&a.removePendingData(u),s&&s(e,t)}),a?a.offlineProvider:null,l),a&&a.addPendingData(u)},u.$.prototype.createCubeTextureBase=function(e,t,r,a,n=null,s=null,i,f=null,u=!1,p=0,d=0,A=null,h=null,y=null,b=!1,C=null){const m=A||new l.h(this,7);m.isCube=!0,m.url=e,m.generateMipMaps=!a,m._lodGenerationScale=p,m._lodGenerationOffset=d,m._useSRGBBuffer=!!b&&this._caps.supportSRGBBuffers&&(this.version>1||this.isWebGPU||!!a),m!==A&&(m.label=e.substring(0,60)),this._doNotHandleContextLost||(m._extension=f,m._files=r,m._buffer=C);const _=e;this._transformTextureUrl&&!A&&(e=this._transformTextureUrl(e));const G=f??function(e){const t=e.split("?")[0],r=t.lastIndexOf(".");return r>-1?t.substring(r).toLowerCase():""}(e),B=(0,c.gT)(G),F=(l,c)=>{e===_?s&&l&&s(l.status+" "+l.statusText,c):(o.V.Warn(`Failed to load ${e}, falling back to the ${_}`),this.createCubeTextureBase(_,t,r,!!a,n,s,i,f,u,p,d,m,h,y,b,C))};if(B)B.then((a=>{const l=e=>{h&&h(m,e),a.loadCubeData(e,m,u,n,s)};C?l(C):r&&6===r.length?a.supportCascades?this._cascadeLoadFiles(t,(e=>l(e.map((e=>new Uint8Array(e))))),r,s):s?s("Textures type does not support cascades."):o.V.Warn("Texture loader does not support cascades."):this._loadFile(e,(e=>l(new Uint8Array(e))),void 0,void 0,!0,F)}));else{if(!r||0===r.length)throw new Error("Cannot load cubemap because files were not defined, or the correct loader was not found.");this._cascadeLoadImgs(t,m,((e,t)=>{y&&y(e,t)}),r,s)}return this._internalTexturesCache.push(m),m};const p=131072,d=131072;function A(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}const h=A("DXT1"),y=A("DXT3"),b=A("DXT5"),C=A("DX10");class m{static GetDDSInfo(e){const t=new Int32Array(e.buffer,e.byteOffset,31),r=new Int32Array(e.buffer,e.byteOffset,35);let a=1;t[2]&p&&(a=Math.max(1,t[7]));const o=t[21],n=o===C?r[32]:0;let s=0;switch(o){case 113:s=2;break;case 116:s=1;break;case C:if(10===n){s=2;break}if(2===n){s=1;break}}return{width:t[4],height:t[3],mipmapCount:a,isFourCC:!(4&~t[20]),isRGB:!(64&~t[20]),isLuminance:(t[20]&d)===d,isCube:!(512&~t[28]),isCompressed:o===h||o===y||o===b,dxgiFormat:n,textureType:s}}static _GetHalfFloatAsFloatRGBAArrayBuffer(e,t,r,a,o,n){const l=new Float32Array(a),i=new Uint16Array(o,r);let f=0;for(let r=0;r<t;r++)for(let t=0;t<e;t++){const a=4*(t+r*e);l[f]=(0,s.SX)(i[a]),l[f+1]=(0,s.SX)(i[a+1]),l[f+2]=(0,s.SX)(i[a+2]),m.StoreLODInAlphaChannel?l[f+3]=n:l[f+3]=(0,s.SX)(i[a+3]),f+=4}return l}static _GetHalfFloatRGBAArrayBuffer(e,t,r,a,o,n){if(m.StoreLODInAlphaChannel){const l=new Uint16Array(a),i=new Uint16Array(o,r);let f=0;for(let r=0;r<t;r++)for(let t=0;t<e;t++){const a=4*(t+r*e);l[f]=i[a],l[f+1]=i[a+1],l[f+2]=i[a+2],l[f+3]=(0,s.LZ)(n),f+=4}return l}return new Uint16Array(o,r,a)}static _GetFloatRGBAArrayBuffer(e,t,r,a,o,n){if(m.StoreLODInAlphaChannel){const s=new Float32Array(a),l=new Float32Array(o,r);let i=0;for(let r=0;r<t;r++)for(let t=0;t<e;t++){const a=4*(t+r*e);s[i]=l[a],s[i+1]=l[a+1],s[i+2]=l[a+2],s[i+3]=n,i+=4}return s}return new Float32Array(o,r,a)}static _GetFloatAsHalfFloatRGBAArrayBuffer(e,t,r,a,o,n){const l=new Uint16Array(a),i=new Float32Array(o,r);let f=0;for(let r=0;r<t;r++)for(let t=0;t<e;t++)l[f]=(0,s.LZ)(i[f]),l[f+1]=(0,s.LZ)(i[f+1]),l[f+2]=(0,s.LZ)(i[f+2]),m.StoreLODInAlphaChannel?l[f+3]=(0,s.LZ)(n):l[f+3]=(0,s.LZ)(i[f+3]),f+=4;return l}static _GetFloatAsUIntRGBAArrayBuffer(e,t,r,o,n,s){const l=new Uint8Array(o),i=new Float32Array(n,r);let f=0;for(let r=0;r<t;r++)for(let t=0;t<e;t++){const o=4*(t+r*e);l[f]=255*(0,a.OQ)(i[o]),l[f+1]=255*(0,a.OQ)(i[o+1]),l[f+2]=255*(0,a.OQ)(i[o+2]),m.StoreLODInAlphaChannel?l[f+3]=s:l[f+3]=255*(0,a.OQ)(i[o+3]),f+=4}return l}static _GetHalfFloatAsUIntRGBAArrayBuffer(e,t,r,o,n,l){const i=new Uint8Array(o),f=new Uint16Array(n,r);let u=0;for(let r=0;r<t;r++)for(let t=0;t<e;t++){const o=4*(t+r*e);i[u]=255*(0,a.OQ)((0,s.SX)(f[o])),i[u+1]=255*(0,a.OQ)((0,s.SX)(f[o+1])),i[u+2]=255*(0,a.OQ)((0,s.SX)(f[o+2])),m.StoreLODInAlphaChannel?i[u+3]=l:i[u+3]=255*(0,a.OQ)((0,s.SX)(f[o+3])),u+=4}return i}static _GetRGBAArrayBuffer(e,t,r,a,o,n,s,l,i){const f=new Uint8Array(a),u=new Uint8Array(o,r);let c=0;for(let r=0;r<t;r++)for(let t=0;t<e;t++){const a=4*(t+r*e);f[c]=u[a+n],f[c+1]=u[a+s],f[c+2]=u[a+l],f[c+3]=u[a+i],c+=4}return f}static _ExtractLongWordOrder(e){return 0===e||255===e||-16777216===e?0:1+m._ExtractLongWordOrder(e>>8)}static _GetRGBArrayBuffer(e,t,r,a,o,n,s,l){const i=new Uint8Array(a),f=new Uint8Array(o,r);let u=0;for(let r=0;r<t;r++)for(let t=0;t<e;t++){const a=3*(t+r*e);i[u]=f[a+n],i[u+1]=f[a+s],i[u+2]=f[a+l],u+=3}return i}static _GetLuminanceArrayBuffer(e,t,r,a,o){const n=new Uint8Array(a),s=new Uint8Array(o,r);let l=0;for(let r=0;r<t;r++)for(let t=0;t<e;t++){const a=t+r*e;n[l]=s[a],l++}return n}static UploadDDSLevels(e,t,r,a,s,l,i=-1,f,u=!0){let c=null;a.sphericalPolynomial&&(c=[]);const d=!!e.getCaps().s3tc;t.generateMipMaps=s;const A=new Int32Array(r.buffer,r.byteOffset,31);let _,G,B,F,D,g,w,L=0,x=0,S=1;if(542327876!==A[0])return void o.V.Error("Invalid magic number in DDS header");if(!a.isFourCC&&!a.isRGB&&!a.isLuminance)return void o.V.Error("Unsupported format, must contain a FourCC, RGB or LUMINANCE code");if(a.isCompressed&&!d)return void o.V.Error("Compressed textures are not supported on this platform.");let O=A[22];F=A[1]+4;let R=!1;if(a.isFourCC)switch(_=A[21],_){case h:S=8,x=33777;break;case y:S=16,x=33778;break;case b:S=16,x=33779;break;case 113:R=!0,O=64;break;case 116:R=!0,O=128;break;case C:{F+=20;let e=!1;switch(a.dxgiFormat){case 10:R=!0,O=64,e=!0;break;case 2:R=!0,O=128,e=!0;break;case 88:a.isRGB=!0,a.isFourCC=!1,O=32,e=!0}if(e)break}default:return void o.V.Error(["Unsupported FourCC code:",(T=_,String.fromCharCode(255&T,T>>8&255,T>>16&255,T>>24&255))])}var T;const U=m._ExtractLongWordOrder(A[23]),I=m._ExtractLongWordOrder(A[24]),k=m._ExtractLongWordOrder(A[25]),v=m._ExtractLongWordOrder(A[26]);R&&(x=e._getRGBABufferInternalSizedFormat(a.textureType)),g=1,A[2]&p&&!1!==s&&(g=Math.max(1,A[7]));const M=f||0,H=e.getCaps();for(let o=M;o<l;o++){for(G=A[4],B=A[3],w=0;w<g;++w){if(-1===i||i===w){const n=-1===i?w:0;if(!a.isCompressed&&a.isFourCC){t.format=5,L=G*B*4;let a=null;if(e._badOS||e._badDesktopOS||!H.textureHalfFloat&&!H.textureFloat)128===O?(a=m._GetFloatAsUIntRGBAArrayBuffer(G,B,r.byteOffset+F,L,r.buffer,n),c&&0==n&&c.push(m._GetFloatRGBAArrayBuffer(G,B,r.byteOffset+F,L,r.buffer,n))):64===O&&(a=m._GetHalfFloatAsUIntRGBAArrayBuffer(G,B,r.byteOffset+F,L,r.buffer,n),c&&0==n&&c.push(m._GetHalfFloatAsFloatRGBAArrayBuffer(G,B,r.byteOffset+F,L,r.buffer,n))),t.type=0;else{const e=H.textureFloat&&(u&&H.textureFloatLinearFiltering||!u),o=H.textureHalfFloat&&(u&&H.textureHalfFloatLinearFiltering||!u),s=(128===O||64===O&&!o)&&e?1:(64===O||128===O&&!e)&&o?2:0;let l,i=null;if(128===O)switch(s){case 1:l=m._GetFloatRGBAArrayBuffer,i=null;break;case 2:l=m._GetFloatAsHalfFloatRGBAArrayBuffer,i=m._GetFloatRGBAArrayBuffer;break;case 0:l=m._GetFloatAsUIntRGBAArrayBuffer,i=m._GetFloatRGBAArrayBuffer}else switch(s){case 1:l=m._GetHalfFloatAsFloatRGBAArrayBuffer,i=null;break;case 2:l=m._GetHalfFloatRGBAArrayBuffer,i=m._GetHalfFloatAsFloatRGBAArrayBuffer;break;case 0:l=m._GetHalfFloatAsUIntRGBAArrayBuffer,i=m._GetHalfFloatAsFloatRGBAArrayBuffer}t.type=s,a=l(G,B,r.byteOffset+F,L,r.buffer,n),c&&0==n&&c.push(i?i(G,B,r.byteOffset+F,L,r.buffer,n):a)}a&&e._uploadDataToTextureDirectly(t,a,o,n)}else if(a.isRGB)t.type=0,24===O?(t.format=4,L=G*B*3,D=m._GetRGBArrayBuffer(G,B,r.byteOffset+F,L,r.buffer,U,I,k),e._uploadDataToTextureDirectly(t,D,o,n)):(t.format=5,L=G*B*4,D=m._GetRGBAArrayBuffer(G,B,r.byteOffset+F,L,r.buffer,U,I,k,v),e._uploadDataToTextureDirectly(t,D,o,n));else if(a.isLuminance){const a=e._getUnpackAlignement(),s=G;L=Math.floor((G+a-1)/a)*a*(B-1)+s,D=m._GetLuminanceArrayBuffer(G,B,r.byteOffset+F,L,r.buffer),t.format=1,t.type=0,e._uploadDataToTextureDirectly(t,D,o,n)}else L=Math.max(4,G)/4*Math.max(4,B)/4*S,D=new Uint8Array(r.buffer,r.byteOffset+F,L),t.type=0,e._uploadCompressedDataToTextureDirectly(t,x,G,B,D,o,n)}F+=O?G*B*(O/8):L,G*=.5,B*=.5,G=Math.max(1,G),B=Math.max(1,B)}if(void 0!==f)break}c&&c.length>0?a.sphericalPolynomial=n.d.ConvertCubeMapToSphericalPolynomial({size:A[4],right:c[0],left:c[1],up:c[2],down:c[3],front:c[4],back:c[5],format:5,type:1,gammaSpace:!1}):a.sphericalPolynomial=void 0}}m.StoreLODInAlphaChannel=!1}}]);